---
title: Age and sex-related variability in the presentation of anxiety and depression
  symptoms in the GLAD Study
author: "Katherine N Thompson"
date: "10/02/2020"
output:
  word_document:
    toc: yes
    toc_depth: '2'
  html_document:
    df_print: paged
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: no
    number_sections: no
    highlight: monochrome
    theme: cerulean
code_folding: show
html_notebook:
  theme: cerulean
toc: yes
---

# Set up
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      comment = NA,
                      prompt = FALSE,
                      cache = FALSE)
```

Delete everything in your global environment
```{r Clear global environment, include=FALSE}
remove(list = ls())
```

Packages
```{r Load packages, include=FALSE}
library(knitr)
library(car)
library(psych)
library(lubridate)
library(broom)
library(summarytools)
library(data.table)
library(eeptools)
library(magrittr)
library(reshape2)
library(lavaan)
library(mlogit)
library(foreign)
library(sjPlot)
library(polycor)
library(REdaS)
library(scales)
library(forcats)
library(GPArotation)
library(tidyverse)
```

Retrieve the recent date
```{r Recent date, include=FALSE}
date = Sys.Date()
```

Define colours for plotting
```{r GLAD colour palette , include=FALSE}
palette = c(
  "#efc00b", #female
  "#b7dee8"  #male
  )

palette3 <- c("#78D9C5","#F5BE5E","#EEB6E9")
```

Read in demographics
```{r read in demographic data, include=FALSE}
data.dem.raw <- readRDS("../../data/DEM.rds")
dim(data.dem.raw)
colnames(data.dem.raw)
data.dem.raw$birthyear <- NULL
data.dem.raw$startdate <- NULL
data.dem.raw$enddate <- NULL
colnames(data.dem.raw)
```

Read in self report mental health disorders
```{r Read in self report mental health disorders, include=FALSE}
data.mhd.raw <- readRDS("../../data/MHD.rds")
dim(data.mhd.raw)
colnames(data.mhd.raw)
data.mhd.raw$sex <- NULL
data.mhd.raw$age <- NULL
data.mhd.raw$birthyear <- NULL
data.mhd.raw$startdate <- NULL
data.mhd.raw$enddate <- NULL
colnames(data.mhd.raw)
```

Read in PHQ9
```{r Read in PHQ, include=FALSE}
data.phq.raw <- readRDS("../../data/PHQ.rds")
dim(data.phq.raw)
colnames(data.phq.raw)
data.phq.raw$sex <- NULL
data.phq.raw$age <- NULL
data.phq.raw$birthyear <- NULL
data.phq.raw$startdate <- NULL
data.phq.raw$enddate <- NULL
colnames(data.phq.raw)
```

Read in GAD7
```{r Read in GAD7, include=FALSE}
data.gad.raw <- readRDS("../../data/GAD.rds")
dim(data.gad.raw)
colnames(data.gad.raw)
data.gad.raw$sex <- NULL
data.gad.raw$age <- NULL
data.gad.raw$birthyear <- NULL
data.gad.raw$startdate <- NULL
data.gad.raw$enddate <- NULL
colnames(data.gad.raw)
```

## Prepare item lists
```{r prepare item groups, include=FALSE}
#All the items in numeric form
ALL.items.full_numeric <- c("phq.anhedonia_numeric",
             "phq.depressed_mood_numeric",
             "phq.sleep_change_numeric",
             "phq.little_energy_numeric",
             "phq.eating_problems_numeric",
             "phq.worthlessness_numeric",
             "phq.concentration_problems_numeric",
             "phq.motor_problems_numeric",
             "phq.suicide_ideation_numeric",
             "gad.feeling_anxious_numeric",
             "gad.control_worrying_numeric",
             "gad.worry_toomuch_numeric",
             "gad.trouble_relaxing_numeric", 
             "gad.restless_numeric", 
             "gad.irritable_numeric",
             "gad.feeling_afraid_numeric")

#All the items as factors
ALL.items.full <- c("phq.anhedonia",
             "phq.depressed_mood",
             "phq.sleep_change",
             "phq.little_energy",
             "phq.eating_problems",
             "phq.worthlessness",
             "phq.concentration_problems",
             "phq.motor_problems",
             "phq.suicide_ideation",
             "gad.feeling_anxious",
             "gad.control_worrying",
             "gad.worry_toomuch",
             "gad.trouble_relaxing", 
             "gad.restless", 
             "gad.irritable",
             "gad.feeling_afraid")

# Create vector with items that are included in total score
GAD.items = c("gad.feeling_anxious_numeric",
              "gad.control_worrying_numeric",
              "gad.worry_toomuch_numeric",
              "gad.trouble_relaxing_numeric",
              "gad.restless_numeric",
              "gad.irritable_numeric",
              "gad.feeling_afraid_numeric")

# Create vector with items that are included in total score
PHQ.items = c("phq.anhedonia_numeric",
              "phq.depressed_mood_numeric",
              "phq.sleep_change_numeric",
              "phq.little_energy_numeric",
              "phq.eating_problems_numeric",
              "phq.worthlessness_numeric",
              "phq.concentration_problems_numeric",
              "phq.motor_problems_numeric",
              "phq.suicide_ideation_numeric")

#list of categorical items
cat.items <- c("phq.anhedonia.cat",
             "phq.depressed_mood.cat",       
             "phq.sleep_change.cat",
             "phq.little_energy.cat",
             "phq.eating_problems.cat",
             "phq.worthlessness.cat",
             "phq.concentration_problems.cat",
             "phq.motor_problems.cat",
             "phq.suicide_ideation.cat",
             "gad.feeling_anxious.cat",
             "gad.control_worrying.cat",
             "gad.worry_toomuch.cat",
             "gad.trouble_relaxing.cat", 
             "gad.restless.cat", 
             "gad.irritable.cat",
             "gad.feeling_afraid.cat")

#categorical items labeled for endorsement plot 
cat.items.labelled <- c("phq.anhedonia.cat.labelled",
             "phq.depressed_mood.cat.labelled",       
             "phq.sleep_change.cat.labelled",
             "phq.little_energy.cat.labelled",
             "phq.eating_problems.cat.labelled",
             "phq.worthlessness.cat.labelled",
             "phq.concentration_problems.cat.labelled",
             "phq.motor_problems.cat.labelled",
             "phq.suicide_ideation.cat.labelled",
             "gad.feeling_anxious.cat.labelled",
             "gad.control_worrying.cat.labelled",
             "gad.worry_toomuch.cat.labelled",
             "gad.trouble_relaxing.cat.labelled", 
             "gad.restless.cat.labelled", 
             "gad.irritable.cat.labelled",
             "gad.feeling_afraid.cat.labelled")

#create data frame that doesn't include "worrying too much" item
ALL.items.full.withoutworry <- c("phq.anhedonia",
                                 "phq.depressed_mood",
                                 "phq.sleep_change",
                                 "phq.little_energy",
                                 "phq.eating_problems",
                                 "phq.worthlessness",
                                 "phq.concentration_problems",
                                 "phq.motor_problems",
                                 "phq.suicide_ideation",
                                 "gad.feeling_anxious",
                                 "gad.control_worrying",
                                 "gad.trouble_relaxing", 
                                 "gad.restless", 
                                 "gad.irritable",
                                 "gad.feeling_afraid")

#create data frame that doesn't include "concentration problems" item
ALL.items.full.withoutconcentration <- c("phq.anhedonia",
                                 "phq.depressed_mood",
                                 "phq.sleep_change",
                                 "phq.little_energy",
                                 "phq.eating_problems",
                                 "phq.worthlessness",
                                 "phq.motor_problems",
                                 "phq.suicide_ideation",
                                 "gad.feeling_anxious",
                                 "gad.control_worrying",
                                 "gad.trouble_relaxing", 
                                 "gad.restless", 
                                 "gad.irritable",
                                 "gad.feeling_afraid")

#create data frame that doesn't include "concentration problems" and "irritability" item
ALL.items.full.withoutirritability <- c("phq.anhedonia",
                                 "phq.depressed_mood",
                                 "phq.sleep_change",
                                 "phq.little_energy",
                                 "phq.eating_problems",
                                 "phq.worthlessness",
                                 "phq.motor_problems",
                                 "phq.suicide_ideation",
                                 "gad.feeling_anxious",
                                 "gad.control_worrying",
                                 "gad.trouble_relaxing", 
                                 "gad.restless",
                                 "gad.feeling_afraid")

#continuous variables for descriptives
continuous.variables <- c("PHQ.total.score", 
                          "GAD.total.score", 
                          "age")
```

PHQ and GAD scoring keys
```{r PHQ and GAD scoring keys, include=FALSE}
##PHQ
PHQ.n.items = 9 #total number of items of the questionnaire

# Create vector with scoring key: If the item is reversed coded use -1. 
# There needs to be the correct number of values for each item in the questionnaire. 
PHQ.items.key <- c(1,1,1,1,1,1,1,1,1)

##GAD
GAD.n.items = 7 #total number of items of the questionnaire

# Create vector with scoring key: If the item is reversed coded use -1. 
# There needs to be the correct number of values for each item in the questionnaire. 
GAD.items.key <- c(1,1,1,1,1,1,1)
```

# Missingness {.tabset .tabset-fade}

## PHQ Missingness NAs per person - count and percentages
```{r PHQ Missingness}
data.phq.raw$na.per.person.phq <- rowSums(is.na(data.phq.raw[,colnames(data.phq.raw) %in% PHQ.items]))
freq(data.phq.raw$na.per.person.phq)

data.phq.raw$miss_pc_total.phq <- data.phq.raw$na.per.person.phq/PHQ.n.items
freq(data.phq.raw$miss_pc_total.phq)
```

## GAD Missingness NAs per person - count and percentages
```{r GAD Missingness}
data.gad.raw$na.per.person.gad <- rowSums(is.na(data.gad.raw[,colnames(data.gad.raw) %in% GAD.items]))
freq(data.gad.raw$na.per.person.gad)

data.gad.raw$miss_pc_total.gad <- data.gad.raw$na.per.person.gad/GAD.n.items
freq(data.gad.raw$miss_pc_total.gad)
```

# Merge PHQ, GAD, demographics and mental health disorders 

Create a list of the data frames to join together 
```{r list of dataframes to merge}
dataframe_list <- list(
  data.dem.raw,
  data.mhd.raw,
  data.gad.raw,
  data.phq.raw
)
```

Join data frames
```{r join all datasets}
data.joined <- plyr::join_all(
  dataframe_list,
  by = "ID" # Alternatively you can join by several columns
  )
#remove duplicate cols
data.joined <- data.joined[, !duplicated(colnames(data.joined))]

#look at the data
# skimr::skim(data.joined)
```

# **Data preparation** {.tabset .tabset-fade}

## Missing data

### Convert all -77, -88 and -99 / "Seen but not answered", "Don't know", and "Prefer not to answer" to NA
```{r convert all -77,-88 and -99 to NA}
#convert all numeric variables to NA
dat <- data.joined %>%
  dplyr::mutate_all(., ~na_if(., -88)) %>% 
  dplyr::mutate_all(., ~na_if(., -99)) %>%
  dplyr::mutate_all(., ~na_if(., -77))
```

### If data import is older [i.e. does not include enddate and startdate]
Change -88 (Don't know), -99 (Prefer not to answer), and -77 (Seen but not answered) to NA
```{r change missing data to NA}
dat <- data.joined %>%
  #select(-c("startdate","enddate")) %>% #Dropping startdate and enddate in new rds files
  mutate_all(., ~na_if(., -88)) %>% 
  mutate_all(., ~na_if(., -99)) %>%
  mutate_all(., ~na_if(., -77)) %>%
  mutate_all(., ~na_if(., "Seen but not answered")) %>%
  mutate_all(., ~na_if(., "Don't know")) %>%
  mutate_all(., ~na_if(., "Prefer not to say"))

# skimr::skim(dat)
#Check the minimum values; there should be no negative values
```

### Getting rid of empty factor levels
```{r Empty factor levels}
dat <- dat %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Seen but not answered")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Don't know")) %>%
  mutate_if(is.factor, ~forcats::fct_drop(., only = "Prefer not to answer"))

#Check that "Seen but not answered', 'Don't know' and 'Prefer not to answer' are not included as factors
# skimr::skim(dat)  
```

## Identify duplicates
```{r Identify duplicates}
dat$ID.dup <- duplicated(dat$ID)

summary(as.factor(dat$ID.dup))

data.dup <- dat %>%
  filter(ID.dup == TRUE)

dat <- dat %>%
  filter(ID.dup == FALSE)
```

37419 is the same as the original rows of the data frames so the sample does not contain duplicated IDs

## Remove age outlier
```{r age outlier check}
# Outlier limits
age_upper_limit = 100
age_lower_limit = 16

#apply age limits
age.unc_upper <- which(dat$age > age_upper_limit)
age.unc_upper
age.unc_lower <- which(dat$age < age_lower_limit)
age.unc_lower

# Number of participants with outlier values
age.unc_outliers <- append(age.unc_upper, age.unc_lower)
length(age.unc_outliers)

# Remove outliers
dat$age <- with(dat, ifelse(age > age_upper_limit | age < age_lower_limit, NA, age))
```

## Remove those without sex, age and incomplete PHQ/GAD items
```{r remove anyone who doesnt report sex or age}
dat <- dat[complete.cases(dat[,"sex"]),]
summary(dat$ID)
dat <- dat[complete.cases(dat[,"age"]),]
summary(dat$ID)
#have removed incomplete PHQ/GAD items for factor analyses and conducting factor scores
dat <- dat[complete.cases(dat[, ALL.items.full_numeric]),]
summary(dat$ID)

#skimr::skim(dat)
```
All participants reported their biological sex and one person had their age missing, as I had previously removed this (age of 290). 1,781 were dropped because they had missing PHQ or GAD items. 

## Categorise age into groups 
```{r define age groups}
#create categorical age groups per 10 years 
dat$age.group_numeric <- case_when(dat$age >= 16 & dat$age <= 25 ~ "1",
                                  dat$age >= 26 & dat$age <= 35 ~ "2",
                                  dat$age >= 36 & dat$age <= 45 ~ "3",
                                  dat$age >= 46 & dat$age <= 55 ~ "4",
                                  dat$age >= 56 & dat$age <= 65 ~ "5",
                                  dat$age >= 66 & dat$age <= 75 ~ "6",
                                  dat$age >= 76 & dat$age <= 85 ~ "7",
                                  dat$age >= 86 & dat$age <= 95 ~ "8")

#create age groups as factors 
dat$age.group.factor <- recode_factor(dat$age.group_numeric,
                                         "1" = "16 to 25 years",
                                         "2" = "26 to 35 years",
                                         "3" = "36 to 45 years",
                                         "4" = "46 to 55 years",
                                         "5" = "56 to 65 years",
                                         "6" = "66 to 75 years",
                                         "7" = "76 to 85 years",
                                         "8" = "86 to 95 years")
#have a look at the data
freq(dat$age.group.factor, cumul = F) 
```

## Create self-report diagnostic groups

```{r create self-report MDD or any anxiety group}
#Reported MDD or any anxiety diagnosis
dat$MDD_anxiety <- ifelse(dat$mhd.MDD_numeric == "1" | 
                            dat$mhd.GAD_numeric == "1" |
                            dat$mhd.social_anxiety_numeric == "1" | 
                            dat$mhd.specific_phobia_numeric == "1" | 
                            dat$mhd.agoraphobia_numeric == "1" | 
                            dat$mhd.panic_disorder_numeric == "1", 1, 0)
dat <- dat %>%
  mutate(
    MDD_anxiety.factor =
    recode_factor(MDD_anxiety, 
                  "1" = "MDD and any anxiety",
                  "0" = "No MDD and any anxiety"
    ))
table(dat$MDD_anxiety.factor)
```

```{r create self-report MDD only group}
#MDD only group - not reported any anxiety disorder
dat$MDD.only <- ifelse(dat$mhd.MDD_numeric == "1" & 
                            dat$mhd.GAD_numeric == "0" &
                            dat$mhd.social_anxiety_numeric == "0" & 
                            dat$mhd.specific_phobia_numeric == "0" & 
                            dat$mhd.agoraphobia_numeric == "0" & 
                            dat$mhd.panic_disorder_numeric == "0", 1, 0)
dat <- dat %>%
  mutate(
    MDD.only.factor =
    recode_factor(MDD.only, 
                  "1" = "MDD only",
                  "0" = "No MDD only"
    ))
table(dat$MDD.only.factor)
```

```{r create self-report GAD only group}
#GAD only group
dat$GAD.only <- ifelse(dat$mhd.GAD_numeric == "1" & 
                            dat$mhd.MDD_numeric == "0" &
                            dat$mhd.social_anxiety_numeric == "0" & 
                            dat$mhd.specific_phobia_numeric == "0" & 
                            dat$mhd.agoraphobia_numeric == "0" & 
                            dat$mhd.panic_disorder_numeric == "0", 1, 0)
dat <- dat %>%
  mutate(
    GAD.only.factor =
    recode_factor(GAD.only, 
                  "1" = "GAD only",
                  "0" = "No GAD only"
    ))
table(dat$GAD.only.factor)
```

```{r create self-report comorbid MDD and GAD only groups}
#Comorbid MDD and GAD
dat$MDD_GAD <- ifelse(dat$mhd.GAD_numeric == "1" & 
                            dat$mhd.MDD_numeric == "1" &
                            dat$mhd.social_anxiety_numeric == "0" & 
                            dat$mhd.specific_phobia_numeric == "0" & 
                            dat$mhd.agoraphobia_numeric == "0" & 
                            dat$mhd.panic_disorder_numeric == "0", 1, 0)
dat <- dat %>%
  mutate(
    MDD_GAD.factor =
    recode_factor(MDD_GAD, 
                  "1" = "Comorbid MDD and GAD only",
                  "0" = "No comorbid MDD and GAD only"
    ))
table(dat$MDD_GAD.factor)
```

```{r create self-report any other anxiety disorder group}
#All who have any other anxiety disorder
dat$anxiety.other.diagnosis <- ifelse(dat$mhd.social_anxiety_numeric == "1" | 
                                            dat$mhd.specific_phobia_numeric == "1" | 
                                            dat$mhd.agoraphobia_numeric == "1" | 
                                            dat$mhd.panic_disorder_numeric == "1", 1, 0)
dat <- dat %>%
  mutate(
    anxiety.other.diagnosis.factor =
    recode_factor(anxiety.other.diagnosis, 
                  "1" = "Other anxiety disorder",
                  "0" = "No other anxiety disorder"
    ))
table(dat$anxiety.other.diagnosis.factor)
```

```{r create self-report any other anxiety disorder only group}
#all who have any other anxiety disorder only 
dat$anxiety.other.diagnosis.only <- ifelse((dat$mhd.social_anxiety_numeric == "1" | 
                                            dat$mhd.specific_phobia_numeric == "1" | 
                                            dat$mhd.agoraphobia_numeric == "1" | 
                                            dat$mhd.panic_disorder_numeric == "1" &
                                            (dat$mhd.GAD_numeric == "0") &  
                                            dat$mhd.MDD_numeric == "0"), 1, 0)
dat <- dat %>%
  mutate(
    anxiety.other.diagnosis.only.factor =
    recode_factor(anxiety.other.diagnosis.only, 
                  "1" = "Other anxiety disorder without MDD and GAD",
                  "0" = "No other anxiety disorder without MDD and GAD"
    ))
table(dat$anxiety.other.diagnosis.only.factor)
```

## Create data sets with just men/women
```{r datasets for males and males}
data.female <- dat %>% filter(sex == "Female")
data.male <- dat %>% filter (sex == "Male")
```

## Create Highest Education variable

Assumes Degree > A level > NVQ > CSE/GCSE
```{r define highest education}
#create numeric version of the highest education variable
dat <- dat %>%
  mutate(
    highest_education_numeric =
      case_when(
        dem.university == "Yes" ~ 4,
        dem.alevels == "Yes" ~ 3,
        dem.NVQ == "Yes" ~ 2,
        dem.gcse == "Yes" ~ 1,
        dem.cse == "Yes" ~ 1))

#recode the numeric version into a factor
dat <- dat %>%
  mutate(
    highest_education =
      recode_factor(highest_education_numeric,
        `1` = "GCSE/CSE",
        `2` = "NVQ",
        `3` = "A-levels",
        `4` = "University"))

freq(dat$highest_education)
```

## Categroise PHQ-9 and GAD-7 items

### PHQ
```{r making PHQ items categorical}
#categorise the PHQ items for the logistic regressions
dat$phq.depressed_mood.cat <- ifelse(dat$phq.depressed_mood_numeric > 0, 1, 0)
dat$phq.anhedonia.cat <- ifelse(dat$phq.anhedonia_numeric > 0, 1, 0)
dat$phq.sleep_change.cat <- ifelse(dat$phq.sleep_change_numeric > 0, 1, 0)
dat$phq.little_energy.cat <- ifelse(dat$phq.little_energy_numeric > 0, 1, 0)
dat$phq.eating_problems.cat <- ifelse(dat$phq.eating_problems_numeric > 0, 1, 0)
dat$phq.worthlessness.cat <- ifelse(dat$phq.worthlessness_numeric > 0, 1, 0)
dat$phq.concentration_problems.cat <- ifelse(dat$phq.concentration_problems_numeric > 0, 1, 0)
dat$phq.motor_problems.cat <- ifelse(dat$phq.motor_problems_numeric > 0, 1, 0)
dat$phq.suicide_ideation.cat <- ifelse(dat$phq.suicide_ideation_numeric > 0, 1, 0)

table(dat$phq.depressed_mood.cat)
```

### GAD
```{r making GAD items categorical}
#categorise the GAD items for the logistic regressions
dat$gad.feeling_anxious.cat <- ifelse(dat$gad.feeling_anxious_numeric > 0, 1, 0)
dat$gad.control_worrying.cat <- ifelse(dat$gad.control_worrying_numeric > 0, 1, 0)
dat$gad.worry_toomuch.cat <- ifelse(dat$gad.worry_toomuch_numeric > 0, 1, 0)
dat$gad.trouble_relaxing.cat <- ifelse(dat$gad.trouble_relaxing_numeric > 0, 1, 0)
dat$gad.restless.cat <- ifelse(dat$gad.restless_numeric > 0, 1, 0)
dat$gad.irritable.cat <- ifelse(dat$gad.irritable_numeric > 0, 1, 0)
dat$gad.feeling_afraid.cat <- ifelse(dat$gad.feeling_afraid_numeric > 0, 1, 0)

table(dat$gad.feeling_anxious.cat)
```

## Total scores

### PHQ
```{r calculate PHQ total score }
#calulate total score
PHQ.scored.items <- scoreItems(keys = PHQ.items.key,
                                        items = dat[PHQ.items],
                                        totals = TRUE, 
                                        missing = TRUE, 
                                        impute = 'none', #this should not matter as the data is full
                                        min = 0, 
                                        max = 3)
#Add in column to data frame
dat$PHQ.total.score <- PHQ.scored.items$scores

table(dat$PHQ.total.score)
```

### GAD
```{r calculate GAD total score }
#calulate total score
GAD.scored.items <- scoreItems(keys = GAD.items.key,
                                        items = dat[GAD.items],
                                        totals = TRUE, 
                                        missing = TRUE, 
                                        impute = 'none', 
                                        min = 0, 
                                        max = 3)
#Add in column to data frame
dat$GAD.total.score <- GAD.scored.items$scores

table(dat$GAD.total.score)
```

## Create ordered factors for PHQ anf GAD items to aid labelling for endorsement plot

```{r create ordered factors for endorsement plot}
dat$phq.anhedonia.cat.labelled <- recode_factor(dat$phq.anhedonia.cat, 
                                          "0" = "Did not report symptom", 
                                           "1" = "Reported symptom")

dat$phq.depressed_mood.cat.labelled <- recode_factor(dat$phq.depressed_mood.cat, 
                                           "0" = "Did not report symptom", 
                                           "1" = "Reported symptom")

dat$phq.suicide_ideation.cat.labelled <- recode_factor(dat$phq.suicide_ideation.cat, 
                                          "0" = "Did not report symptom", 
                                           "1" = "Reported symptom")

dat$phq.concentration_problems.cat.labelled <- recode_factor(dat$phq.concentration_problems.cat, 
                                           "0" = "Did not report symptom", 
                                           "1" = "Reported symptom")

dat$phq.worthlessness.cat.labelled <- recode_factor(dat$phq.worthlessness.cat, 
                                           "0" = "Did not report symptom", 
                                           "1" = "Reported symptom")

dat$phq.little_energy.cat.labelled <- recode_factor(dat$phq.little_energy.cat, 
                                           "0" = "Did not report symptom", 
                                           "1" = "Reported symptom")

dat$phq.eating_problems.cat.labelled <- recode_factor(dat$phq.eating_problems.cat, 
                                           "0" = "Did not report symptom", 
                                           "1" = "Reported symptom")

dat$phq.sleep_change.cat.labelled <- recode_factor(dat$phq.sleep_change.cat, 
                                           "0" = "Did not report symptom", 
                                           "1" = "Reported symptom")

dat$phq.motor_problems.cat.labelled <- recode_factor(dat$phq.motor_problems.cat, 
                                          "0" = "Did not report symptom", 
                                           "1" = "Reported symptom")

dat$gad.worry_toomuch.cat.labelled <- recode_factor(dat$gad.worry_toomuch.cat, 
                                           "0" = "Did not report symptom", 
                                           "1" = "Reported symptom")

dat$gad.control_worrying.cat.labelled <- recode_factor(dat$gad.control_worrying.cat, 
                                           "0" = "Did not report symptom", 
                                           "1" = "Reported symptom")

dat$gad.feeling_anxious.cat.labelled <- recode_factor(dat$gad.feeling_anxious.cat, 
                                           "0" = "Did not report symptom", 
                                           "1" = "Reported symptom")

dat$gad.feeling_afraid.cat.labelled <- recode_factor(dat$gad.feeling_afraid.cat, 
                                           "0" = "Did not report symptom", 
                                           "1" = "Reported symptom")

dat$gad.trouble_relaxing.cat.labelled <- recode_factor(dat$gad.trouble_relaxing.cat, 
                                           "0" = "Did not report symptom", 
                                           "1" = "Reported symptom")

dat$gad.restless.cat.labelled <- recode_factor(dat$gad.restless.cat, 
                                           "0" = "Did not report symptom", 
                                           "1" = "Reported symptom")

dat$gad.irritable.cat.labelled <- recode_factor(dat$gad.irritable.cat, 
                                           "0" = "Did not report symptom", 
                                           "1" = "Reported symptom")
```

# **Sample descriptives**

## Demographics
```{r call packages for descriptives, include=FALSE}
library(janitor)
library(tidyr)
library(tidyverse)
```

```{r descriptives for age}
continuous_age_descriptives_raw <- dat %>%
  group_by(sex) %>%
  summarise(mean = mean(age), sd = sd(age), min = min(age), max = max(age)) %>%
  pivot_longer(cols = c("mean", "sd", "min", "max")) %>%
  rename(descriptive = name) %>%
  pivot_wider(names_from = sex, values_from = value) %>%
  mutate(Total = 
           c(mean(dat$age), sd(dat$age), min(dat$age), max(dat$age)),
         sd_male = c(sd(data.male$age), NA_real_, NA_real_, NA_real_),
         sd_female = c(sd(data.female$age), NA_real_, NA_real_, NA_real_),
         sd_total = c(sd(dat$age), NA_real_, NA_real_, NA_real_)) %>%
  select(
    "Descriptive" = descriptive,
    "Male" = Male,
    "% Male" = sd_male,
    "Female" = Female,
    "% Female" = sd_female,
    "Total" = Total,
    "% Total" = sd_total) 
  
continuous_age_descriptives <- continuous_age_descriptives_raw[-c(2), ]
```

```{r descriptives for age group}
age_group_descriptives <- dat %>% #create object to bind later on
  count(sex, age.group.factor) %>%
  mutate(Prop = round(n/sum(n)*100, 2)) %>%
  pivot_wider(names_from = sex, values_from = c(n, Prop)) %>%
  mutate(Total = n_Male + n_Female,
         Prop_total = Prop_Male + Prop_Female) %>% 
  select(
    "Descriptive" = age.group.factor,
    "Male" = n_Male,
    "% Male" = Prop_Male,
    "Female" = n_Female,
    "% Female" = Prop_Female,
    "Total" = Total,
    "% Total" = Prop_total)
age_group_descriptives 
```

```{r descriptives for highest education}
highest_education_descriptives.raw <- dat %>% #create object to bind later on
  count(sex, highest_education) %>%
  mutate(Prop = round(n/sum(n)*100, 2)) %>%
  pivot_wider(names_from = sex, values_from = c(n, Prop)) %>%
  mutate(Total = n_Male + n_Female,
         Prop_total = Prop_Male + Prop_Female) %>% 
  select(
    "Descriptive" = highest_education,
    "Male" = n_Male,
    "% Male" = Prop_Male,
    "Female" = n_Female,
    "% Female" = Prop_Female,
    "Total" = Total,
    "% Total" = Prop_total)
highest_education_descriptives <- highest_education_descriptives.raw[-c(5),]
```

```{r descriptives for self-report diagnosis}
#MDD total
diagnosis_descriptives_mdd.raw <- dat %>% #create object to bind later on
  count(sex, mhd.MDD) %>%
  mutate(Prop = round(n/sum(n)*100, 2)) %>%
  pivot_wider(names_from = sex, values_from = c(n, Prop)) %>%
  mutate(Total = n_Male + n_Female,
         Prop_total = Prop_Male + Prop_Female) %>% 
  select(
    "Descriptive" = mhd.MDD,
    "Male" = n_Male,
    "% Male" = Prop_Male,
    "Female" = n_Female,
    "% Female" = Prop_Female,
    "Total" = Total,
    "% Total" = Prop_total)

diagnosis_descriptives_mdd <- diagnosis_descriptives_mdd.raw[-c(1,3), ] 

#mdd only 
diagnosis_descriptives_mdd_only.raw <- dat %>% #create object to bind later on
  count(sex, MDD.only.factor) %>%
  mutate(Prop = round(n/sum(n)*100, 2)) %>%
  pivot_wider(names_from = sex, values_from = c(n, Prop)) %>%
  mutate(Total = n_Male + n_Female,
         Prop_total = Prop_Male + Prop_Female) %>% 
  select(
    "Descriptive" = MDD.only.factor,
    "Male" = n_Male,
    "% Male" = Prop_Male,
    "Female" = n_Female,
    "% Female" = Prop_Female,
    "Total" = Total,
    "% Total" = Prop_total)

diagnosis_descriptives_mdd_only <- diagnosis_descriptives_mdd_only.raw[-c(2,3), ]

#GAD
diagnosis_descriptives_gad.raw <- dat %>% #create object to bind later on
  count(sex, mhd.GAD) %>%
  mutate(Prop = round(n/sum(n)*100, 2)) %>%
  pivot_wider(names_from = sex, values_from = c(n, Prop)) %>%
  mutate(Total = n_Male + n_Female,
         Prop_total = Prop_Male + Prop_Female) %>% 
  select(
    "Descriptive" = mhd.GAD,
    "Male" = n_Male,
    "% Male" = Prop_Male,
    "Female" = n_Female,
    "% Female" = Prop_Female,
    "Total" = Total,
    "% Total" = Prop_total)

diagnosis_descriptives_gad <- diagnosis_descriptives_gad.raw[-c(1,3), ] 

#GAD only
diagnosis_descriptives_gad_only.raw <- dat %>% #create object to bind later on
  count(sex, GAD.only.factor) %>%
  mutate(Prop = round(n/sum(n)*100, 2)) %>%
  pivot_wider(names_from = sex, values_from = c(n, Prop)) %>%
  mutate(Total = n_Male + n_Female,
         Prop_total = Prop_Male + Prop_Female) %>% 
  select(
    "Descriptive" = GAD.only.factor,
    "Male" = n_Male,
    "% Male" = Prop_Male,
    "Female" = n_Female,
    "% Female" = Prop_Female,
    "Total" = Total,
    "% Total" = Prop_total)

diagnosis_descriptives_gad_only <- diagnosis_descriptives_gad_only.raw[-c(2,3), ]

#Other anxiety diagnoses
diagnosis_descriptives_other_anxiety.raw <- dat %>% #create object to bind later on
  count(sex, anxiety.other.diagnosis.factor) %>%
  mutate(Prop = round(n/sum(n)*100, 2)) %>%
  pivot_wider(names_from = sex, values_from = c(n, Prop)) %>%
  mutate(Total = n_Male + n_Female,
         Prop_total = Prop_Male + Prop_Female) %>% 
  select(
    "Descriptive" = anxiety.other.diagnosis.factor,
    "Male" = n_Male,
    "% Male" = Prop_Male,
    "Female" = n_Female,
    "% Female" = Prop_Female,
    "Total" = Total,
    "% Total" = Prop_total)

diagnosis_descriptives_other_anxiety <- diagnosis_descriptives_other_anxiety.raw[-c(2,3), ]

#Other anxiety disorder without MDD and GAD
diagnosis_descriptives_other_anxiety.only.raw <- dat %>% #create object to bind later on
  count(sex, anxiety.other.diagnosis.only.factor) %>%
  mutate(Prop = round(n/sum(n)*100, 2)) %>%
  pivot_wider(names_from = sex, values_from = c(n, Prop)) %>%
  mutate(Total = n_Male + n_Female,
         Prop_total = Prop_Male + Prop_Female) %>% 
  select(
    "Descriptive" = anxiety.other.diagnosis.only.factor,
    "Male" = n_Male,
    "% Male" = Prop_Male,
    "Female" = n_Female,
    "% Female" = Prop_Female,
    "Total" = Total,
    "% Total" = Prop_total)

diagnosis_descriptives_other_anxiety.only <- diagnosis_descriptives_other_anxiety.only.raw[-c(2,3), ]

#bind all rows together
diagnosis_descriptives <- rbind(diagnosis_descriptives_mdd, 
                              diagnosis_descriptives_mdd_only, 
                              diagnosis_descriptives_gad, 
                              diagnosis_descriptives_gad_only, 
                              diagnosis_descriptives_other_anxiety,
                              diagnosis_descriptives_other_anxiety.only)
```

```{r descriptives for ethnicity }
ethnicity_descriptives.raw <- dat %>% #create object to bind later on
  count(sex, dem.ethnicity) %>%
  mutate(Prop = round(n/sum(n)*100, 2)) %>%
  pivot_wider(names_from = sex, values_from = c(n, Prop)) %>%
  mutate(Total = n_Male + n_Female,
         Prop_total = Prop_Male + Prop_Female) %>% 
  select(
    "Descriptive" = dem.ethnicity,
    "Male" = n_Male,
    "% Male" = Prop_Male,
    "Female" = n_Female,
    "% Female" = Prop_Female,
    "Total" = Total,
    "% Total" = Prop_total)

ethnicity_descriptives <- ethnicity_descriptives.raw[-c(7), ]
ethnicity_descriptives
```

```{r bind all descriptives together}
descriptives <- bind_rows(
  continuous_age_descriptives,
  age_group_descriptives,
  ethnicity_descriptives,
  highest_education_descriptives,
  diagnosis_descriptives
)

#add in column to show which descriptives they are
descriptives <- descriptives %>%
  mutate(
    Category = 
      c("Age", "Age", "Age",
        "Age group", "Age group", "Age group", "Age group", "Age group", "Age group", "Age group", "Age group",
        "Ethnicity", "Ethnicity", "Ethnicity", "Ethnicity", "Ethnicity", "Ethnicity",
        "Highest education level", "Highest education level", "Highest education level", "Highest education level",
        "Self-reported diagnosis", "Self-reported diagnosis", "Self-reported diagnosis", "Self-reported diagnosis", "Self-reported diagnosis", "Self-reported diagnosis"),
    Male = round(Male, 0),
    Female = round(Female, 0),
    Total = round(Total, 0),
    `% Male /SD`= round(`% Male`, 2),
    `% Female /SD`= round(`% Female`, 2),
    `% Total`= round(`% Total`, 2)) %>%
select(
    Category,
    Descriptive,
    Male,
    `% Male /SD`,
    Female,
    `% Female /SD`,
    Total,
    `% Total`) 

#final table to be viewed in word
kable(descriptives) 
```

```{r RE create datasets for males and males, include=FALSE}
data.female <- dat %>% filter(sex == "Female")
data.male <- dat %>% filter (sex == "Male")
```

## Continuous descriptives
```{r continuous descriptives for age}
library(tidyverse)
dat %>%
  group_by(sex) %>%
  descr(dat[,continuous.variables],
      round.digits = 2,
      transpose = FALSE)

descr(x = dat[,continuous.variables],
      round.digits = 2,
      transpose = TRUE)
```

## Individuals that meet current cut off criteria for GAD-7 and PHQ-9

* PHQ criteria: Those who score above 9
* GAD criteria: Those who score above 7

```{r how many meet current cut off}
#how many meet the cinical cut-off for PHQ
meetPHQcutoff <- ifelse(dat$PHQ.total.score > 9, 1, 0)
table(meetPHQcutoff)

#how many meet the cinical cut-off for GAD
meetGADcutoff <- ifelse(dat$GAD.total.score > 6, 1, 0)
table(meetGADcutoff)
```

## Endorsement of items: likert scale plot 
```{r likert plot of PHQ and GAD items}
endorsement_plot <- sjPlot::plot_likert(
  items = dat[,cat.items.labelled],
  title = "Endorsement of PHQ-9 and GAD-7 symptoms in GLAD",
  axis.labels = c("Anhedonia",
             "Depressed mood",
             "Sleep change",
             "Little energy",
             "Weight or Appetite problems",
             "Worthlessness",
             "Concentration problems",
             "Motor problems",
             "Suicide ideation",
             "Feeling anxious",
             "Difficulty controlling worrying",
             "Worry too much",
             "Trouble relaxing", 
             "Restlessness", 
             "Irritable",
             "Feeling afraid"),
  wrap.labels = 20,
  digits = 0,
  reverse.scale = TRUE,
  cat.neutral = NULL,
  value = "show",
  catcount = 2,
  geom.colors = c("#b7dee8","#efc00b"))

#have a look at the plot
endorsement_plot

#save the plot
ggsave(
  "endorsement_plot.pdf",
  plot = endorsement_plot,
  device = "pdf",
  path = "../plots/endorsement_plot/",
  width = 8,
  height = 9
)
#png
ggsave(
  "endorsement_plot.png",
  plot = endorsement_plot,
  device = "png",
  path = "../plots/endorsement_plot/",
  width = 8,
  height = 9
)
#jpeg
ggsave(
  "endorsement_plot.jpeg",
  plot = endorsement_plot,
  device = "jpeg",
  path = "../plots/endorsement_plot/",
  width = 8,
  height = 9
)
```

# **Preparation for factor analyses**

## Split groups into confirmatory and exploratory 
```{r split the sample into confirmatory and exploratory}
# Set seed to make results reproducible
set.seed(1234)
#Create training set
exploratory.group <- dat %>% 
  sample_frac(
    size = .70, # Percentage of sample to select
    replace = FALSE # With or without replacement of individuals (does the same row get sampled repeatedly)
    )
dim(exploratory.group) # Check the number of rows and columns

#Create test set
confirmatory.group  <- anti_join(dat, 
                                 exploratory.group, 
                                 by = "ID")
dim(confirmatory.group) # Check the number of rows and columns
```

Select the data for EFA and CFA 
```{r select data for efa and cfa}
#select data for efa
data.efa <- exploratory.group %>%
  dplyr::select(all_of(ALL.items.full))

#check dimenions
dim(data.efa)

#select data for cfa
data.cfa <- confirmatory.group %>%
  dplyr::select(all_of(ALL.items.full))

#check dimensions
dim(data.cfa)
```

# **Exploratory factor analysis (EFA)**

## Polychoric correlation matrix
```{r create data frame for correlation matrix}
ALL.items.full.df <- as.data.frame(exploratory.group [,ALL.items.full])  #create your dataframe with the items and group that you want

is.data.frame(ALL.items.full.df)  #check that it is now a dataframe (this is important for the factor analysis function as it has problems with tibbles)

colnames(ALL.items.full.df) <- c("Anhedonia",   #Add in the names you would like for your variables
                                 "Depressed mood", 
                                 "Sleep change", 
                                 "Little energy", 
                                 "Weight or Appetite problems",
                                 "Worthlessness", 
                                 "Concentration problems", 
                                 "Motor problems", 
                                 "Suicide ideation", 
                                 "Feeling anxious", 
                                 "Difficulty controlling worrying", 
                                 "Worry too much", 
                                 "Trouble relaxing", 
                                 "Restlessness", 
                                 "Irritable", 
                                 "Feeling afraid")
head(ALL.items.full.df) #Have a look at the dataframe
```

## Create polychoric matrix for EFA
```{r polychoric correlation matrix for EFA}
# polycor_matrix <- polycor::hetcor(
#   ALL.items.full.df,
# #  ML = TRUE, # maximum likelihood calculation (This can take a few minutes to run), include this if you are using ML in FA
#   use = "pairwise.complete.obs", # Use pairwise complete observations to maximise n
#   digits = 2 # print two digits after the floating point
#   )
# 
# #save object so no need to re-run
# saveRDS(polycor_matrix, file = "../saved_r_objects/polycor_matrix.rds")
polycor_matrix <- readRDS("../saved_r_objects/polycor_matrix.rds")

polycor_matrix #have a look at the matrix
```

## Test assumptions for a factor analysis

### Calulating ordinal alpha

Ordinal apla is a reliability statistic that focuses on the reliability of the unobserved continuous variables underlying the observed item responses. It's shown to estimate reliability more accurately than Cronbach’s alpha for binary and ordinal response scales.
Here you want to look at the "ordinal alpha" as this is a better use than usually Cronbach's alpha which is used for Pearson's correlations. 
Typically, the alpha for a scale should not be smaller than 0.70 when used for research purposes (Gadermann & Zumbo, 2012)
```{r calculate Ordinal alpha, KMO and bartletts}
psych::alpha(
  polycor_matrix$correlations,
  check.keys = TRUE) #This is to take into account those variables that are reverse coded/negatively related.
```

### Kaiser-Meyer-Olkin (KMO) factor adequacy

The KMO is a measure of how suited your data is for Factor Analysis. The test measures sampling adequacy for each variable in the model and for the complete model. Values range from 0-1.
0 indicates that the sum of partial correlations between variables is large relative to the sum of correlations, indicating diffusion (widely spread) in the pattern of correlations, hence, factor analysis is likely to be inappropriate. 
A Value close to 1 indicates that patterns of correlations are relatively compact and so factor analysis should yield distinct and reliable factors. Authors reccommend KMO of >0.8 to be mertitorious, and >0.9 to be marvelous (their words not mine)
```{r KMO}
psych::KMO(
  r = polycor_matrix$correlations
  )
```

### Bartlett's Test of Sphericity 

Bartlett’s test tells us whether the correlation matrix is significantly different to an identity matrix (if the variables did not correlate at all - the off-diagonal components are 0). If it is significant then it means the correlation variables are overall significantly different from 0. 
Bartlett's Test of Sphericity is supposed to be significant to run FA. 
```{r Bartletts sphercity}
REdaS::bart_spher(
  polycor_matrix$correlations
  )
```

### Multicoliniearity test 

To test for multicollinearity, you can examine the determinant of the R matrix. 
The determinant (det) of the R matrix should be greater than 0.00001.  
```{r determinant of correlation matrix}
det(polycor_matrix$correlations) #determinant of R matrix
```

## Create heat map to examine correlation coefficients between all the items of PHQ-9 and GAD-7

Use this to look at multicollinearity too. 
```{r correlation heat map for all items}
#Get lower triangle of the correlation matrix
  get_lower_tri <- function(cor_matrix){
    cor_matrix[upper.tri(cor_matrix)] <- NA
    return(cor_matrix)
  }

#Get upper triangle of the correlation matrix
  get_upper_tri <- function(cor_matrix){
    cor_matrix[lower.tri(cor_matrix)]<- NA
    return(cor_matrix)
  }
  
#upper_tri <- get_upper_tri(cor_matrix)
lower_tri <- get_lower_tri(polycor_matrix$correlations)

reorder_cor_matrix <- function(cor_matrix){
 #Use correlation between variables as distance
 dd <- as.dist((1-cor_matrix)/2)
 hc <- hclust(dd)
 cormat <-cor_matrix[hc$order, hc$order]
 }

# Reorder the correlation matrix
cor_matrix_full <- reorder_cor_matrix(polycor_matrix$correlations)
lower_tri <- get_lower_tri(cor_matrix_full)
  
#melt the values
metled_cor_matrix <- melt(cor_matrix_full, na.rm = TRUE)
metled_cor_matrix

#correlation heat map
correlation_heat_map <- ggplot(metled_cor_matrix, aes(Var2, Var1, fill = value))+
 geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white",
   midpoint = 0, limit = c(-1,1), space = "Lab",
    name="Polychoric\nCorrelation") +
  theme_minimal() +
  labs(y = "Items",
       x = "Items",
       title = "Correlation heat map for PHQ-9 and GAD-7 items in GLAD",
       subtitle = paste("n = ", sum(!is.na(dat$PHQ.total.score)),
                        "; NA = ", sum(is.na(dat$PHQ.total.score)),
                        "; n(total) = ", length(dat$PHQ.total.score),
                        "; n(female) = ", sum(!is.na(dat$PHQ.total.score[dat$sex=="Female"])),
                        "; n(male) = ", sum(!is.na(dat$PHQ.total.score[dat$sex=="Male"])), sep = ""))+
 theme(axis.text.x = element_text(angle = 45, vjust = 1,
    size = 12, hjust = 1))+
 coord_fixed() +
  geom_text(aes(Var2, Var1, label = round(value, digits = 2)), color = "black", size = 3)
correlation_heat_map

correlation_heat_map

#save in pdf
ggsave(
  "correlation_heat_map.pdf",
  plot = correlation_heat_map,
  device = "pdf",
  path = "../plots/correlation_heat_map/",
  width = 9,
  height = 9
)
#save in png
ggsave(
  "correlation_heat_map.png",
  plot = correlation_heat_map,
  device = "png",
  path = "../plots/correlation_heat_map/",
  width = 9,
  height = 9
)
#save in jpeg
ggsave(
  "correlation_heat_map.jpeg",
  plot = correlation_heat_map,
  device = "jpeg",
  path = "../plots/correlation_heat_map/",
  width = 9,
  height = 9
)
```

## Polychoric correlation matrix without "worrying too much" item

To decrease multicollinearity - have removed "Worrying too much about different things" that is strongly (0.92) correlated with "Unable to stop or control worrying".  
```{r polycor matrix without "worrying too much"}
#create dataframe without worry item
ALL.items.full.df.withoutworry <- as.data.frame(exploratory.group[,ALL.items.full.withoutworry])

is.data.frame(ALL.items.full.df.withoutworry) #check that it is a dataframe
#list the column names to be used in the dataframe
colnames(ALL.items.full.df.withoutworry) <- c("Anhedonia", 
                                              "Depressed mood", 
                                              "Sleep change", 
                                              "Little energy", 
                                              "Weight or Appetite problems", 
                                              "Worthlessness", 
                                              "Concentration problems", 
                                              "Motor problems", 
                                              "Suicide ideation", 
                                              "Feeling anxious", 
                                              "Difficulty controlling worrying", 
                                              "Trouble relaxing", 
                                              "Restlessness", 
                                              "Irritable", 
                                              "Feeling afraid")
ALL.items.full.df.withoutworry

# #create correlation matrix for dataframe without worry item
# polycor_matrix.withoutworry <- polycor::hetcor(ALL.items.full.df.withoutworry,
#                                              #  ML = TRUE,
#                                                use = "pairwise.complete.obs",
#                                                digits = 2)
# 
# #save object so no need to re-run
# saveRDS(polycor_matrix.withoutworry, file = "../saved_r_objects/polycor_matrix.withoutworry.rds")
polycor_matrix.withoutworry <- readRDS("../saved_r_objects/polycor_matrix.withoutworry.rds")

polycor_matrix.withoutworry
```

## Test assumptions of the correlation matrix wihtout worry item - see above for full description of assumptions
```{r checking assumptions for without worry matrix}
#alpha
psych::alpha(
  polycor_matrix.withoutworry$correlations,
  check.keys = TRUE)

#KMO
psych::KMO(
  r = polycor_matrix$correlations
  )

#determinant
det(polycor_matrix.withoutworry$correlations)

#sphericity 
REdaS::bart_spher(
  polycor_matrix.withoutworry$correlations
  )
```

## Heat map for polychoric matrix without worry item
```{r heat map without worry item}
#upper_tri <- get_upper_tri(cor_matrix)
lower_tri <- get_lower_tri(polycor_matrix.withoutworry$correlations)

reorder_cor_matrix <- function(cor_matrix){
 #Use correlation between variables as distance
 dd <- as.dist((1-cor_matrix)/2)
 hc <- hclust(dd)
 cormat <-cor_matrix[hc$order, hc$order]
 }

# Reorder the correlation matrix
cor_matrix_full <- reorder_cor_matrix(polycor_matrix.withoutworry$correlations)
lower_tri <- get_lower_tri(cor_matrix_full)
  
#melt the values
metled_cor_matrix <- melt(cor_matrix_full, na.rm = TRUE)
metled_cor_matrix

#correlaiton heat map
correlation_heat_map_without_worry <- ggplot(metled_cor_matrix, aes(Var2, Var1, fill = value))+
 geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white",
   midpoint = 0, limit = c(-1,1), space = "Lab",
    name="Polychoric\nCorrelation") +
  theme_minimal() +
  labs(y = "Items",
       x = "Items",
       title = "Correlation heat map for PHQ-9 and GAD-7, without worrying too much about different things item",
       subtitle = paste("n = ", sum(!is.na(dat$PHQ.total.score)),
                        "; NA = ", sum(is.na(dat$PHQ.total.score)),
                        "; n(total) = ", length(dat$PHQ.total.score),
                        "; n(female) = ", sum(!is.na(dat$PHQ.total.score[dat$sex=="Female"])),
                        "; n(male) = ", sum(!is.na(dat$PHQ.total.score[dat$sex=="Male"])), sep = ""))+
 theme(axis.text.x = element_text(angle = 45, vjust = 1,
    size = 12, hjust = 1))+
 coord_fixed() +
  geom_text(aes(Var2, Var1, label = round(value, digits = 2)), color = "black", size = 3)

correlation_heat_map_without_worry

#save in pdf
ggsave(
  "correlation_heat_map_without_worry.pdf",
  plot = correlation_heat_map_without_worry,
  device = "pdf",
  path = "../plots/correlation_heat_map/",
  width = 9,
  height = 9
)
#save in png
ggsave(
  "correlation_heat_map_without_worry.png",
  plot = correlation_heat_map_without_worry,
  device = "png",
  path = "../plots/correlation_heat_map/",
  width = 9,
  height = 9
)
#save in jpeg
ggsave(
  "correlation_heat_map_without_worry.jpeg",
  plot = correlation_heat_map_without_worry,
  device = "jpeg",
  path = "../plots/correlation_heat_map/",
  width = 9,
  height = 9
)
```

## Combine two heatmaps together in panel graph - for supplementary material

```{r heat map combined plot}
library(ggpubr)
correlation_heat_map <- correlation_heat_map  + 
  labs(title = "All PhQ-9 and GAD-7 items",
       subtitle = NULL) + 
  theme(plot.title = element_text(size = 12,face = "bold"),
        axis.title.x = element_text(size = 9, face = "bold"),
        axis.title.y = element_text(size = 9, face = "bold"))

correlation_heat_map_without_worry <- correlation_heat_map_without_worry + 
  labs(title = "PhQ-9 and GAD-7 items without worry item ",
       subtitle = NULL) + 
  theme(plot.title = element_text(size = 12,face = "bold"),
        axis.title.x = element_text(size = 9, face = "bold"),
        axis.title.y = element_text(size = 9, face = "bold"))
  
correlation_heat_map_combined <- ggarrange(correlation_heat_map, 
                                           correlation_heat_map_without_worry + font("x.text", size = 10),
                                           ncol = 2, nrow = 1, labels = c("A", "B"), 
                                           common.legend = TRUE,
                                           legend = "right")

correlation_heat_map_combined

#save the plot
ggsave(
  "correlation_heat_map_combined.pdf",
  plot = correlation_heat_map_combined,
  device = "pdf",
  path = "../plots/correlation_heat_map/",
  width = 16,
  height = 7
)
#png
ggsave(
  "correlation_heat_map_combined.png",
  plot = correlation_heat_map_combined,
  device = "png",
  path = "../plots/correlation_heat_map/",
  width = 16,
  height = 7
)
#jpeg
ggsave(
  "correlation_heat_map_combined.jpeg",
  plot = correlation_heat_map_combined,
  device = "jpeg",
  path = "../plots/efa/",
  width = 16,
  height = 7
)
```

## Testing for right amount of factors

### Very Simple Structure (VSS)
Used to estimate how many factors are in our data. This can then be used as a starting point for our EFA. 
VSS fits the very simple structure of a factor pattern matrix (correlations between the variables and the factors) to the original correlation matrix.
```{r EFA very simple structure (VSS)}
# fa.vss <- psych::vss(x = polycor_matrix$correlations, # Correlation matrix
#            n = 3, # assumed number of factors
#            rotate = "oblimin", # Rotation type: oblique or orthogonal
#            fm = "wls", #factoring method: "wls" = weighted least squares, "mle" = Maximum Likelihood 
#            n.obs = max(polycor_matrix$n), # number of observations/participants
#            cor = "poly" # Type of correlation matrix
#            )
# 
# #save object so no need to re-run
# saveRDS(fa.vss, file = "../saved_r_objects/fa.vss.rds")
fa.vss <- readRDS("../saved_r_objects/fa.vss.rds")

#also gives MAP criterion
fa.vss
```

### EFA parallel factors technique
Used to estimate how many factors are in our data. This can then be used as a starting point for our EFA. 
Essentially each eigenvalue (which represents the size of the factor) is compared against an eigenvalue for the corresponding factor in many randomly generated data sets that have the same characteristics as the data being analysed.
```{r EFA parallel factors technique}
# fa.parallel <- fa.parallel(x = polycor_matrix$correlations, 
#                                       fm = "wls", #factoring method: "wls" = weighted least squares, "mle" = Maximum Likelihood 
#                                       nfactors = 3, # assumed number of factors
#                                       n.iter = 1000, # number of iterations
#                                       error.bars = T, #include error bars
#                                       cor = "poly", #polychoric correlations
#                                       n.obs = max(polycor_matrix$n) # number of participants
#                                       )
# #save object so no need to re-run
# saveRDS(fa.parallel, file = "../saved_r_objects/fa.parallel.rds")
fa.parallel <- readRDS("../saved_r_objects/fa.parallel.rds")

fa.parallel 
#Also gives eigenvalues 
```

### Very Simple Structure (VSS) - without worry
Used to estimate how many factors are in our data. This can then be used as a starting point for our EFA. 
VSS fits the very simple structure of a factor pattern matrix (correlations between the variables and the factors) to the original correlation matrix.
```{r EFA very simple structure (VSS) - without worry}
# fa.vss.withoutworry <- psych::vss(x = polycor_matrix.withoutworry$correlations, # Correlation matrix
#            n = 3, # assumed number of factors
#            rotate = "oblimin", # Rotation type: oblique or orthogonal
#            fm = "wls", #factoring method: "wls" = weighted least squares, "mle" = Maximum Likelihood 
#            n.obs = max(polycor_matrix$n), # number of observations/participants
#            cor = "poly" # Type of correlation matrix
#            )
# 
# #save object so no need to re-run
# saveRDS(fa.vss.withoutworry, file = "../saved_r_objects/fa.vss.withoutworry.rds")
fa.vss.withoutworry <- readRDS("../saved_r_objects/fa.vss.withoutworry.rds")

#also gives MAP criterion
fa.vss.withoutworry
plot(fa.vss.withoutworry)
```

```{r save vss plot without worry}
jpeg(
    filename = "../plots/efa/vss.scree.withoutworry.jpeg",
    width = 8,
    height = 7,
    units = "in",
    res = 500)
plot(fa.vss.withoutworry)
dev.off()
```

### EFA parallel factors technique - without worry
Used to estimate how many factors are in our data. This can then be used as a starting point for our EFA. 
Essentially each eigenvalue (which represents the size of the factor) is compared against an eigenvalue for the corresponding factor in many randomly generated data sets that have the same characteristics as the data being analysed.
```{r EFA parallel factors technique - without worry}
# fa.parallel.withoutworry <- fa.parallel(x = polycor_matrix.withoutworry$correlations, 
#                                       fm = "wls", #factoring method: "wls" = weighted least squares, "mle" = Maximum Likelihood 
#                                       nfactors = 3, # assumed number of factors
#                                       n.iter = 1000, # number of iterations
#                                       error.bars = T, #include error bars
#                                       cor = "poly", #polychoric correlations
#                                       n.obs = max(polycor_matrix$n) # number of participants
#                                       )
# 
# #save object so no need to re-run
# saveRDS(fa.parallel.withoutworry, file = "../saved_r_objects/fa.parallel.withoutworry.rds")
fa.parallel.withoutworry <- readRDS("../saved_r_objects/fa.parallel.withoutworry.rds")

fa.parallel.withoutworry
#Also gives eigenvalues 
```

```{r save parallel plot without worry}
jpeg(
    filename = "../plots/efa/parallel.scree.withoutworry.jpeg",
    width = 8,
    height = 7,
    units = "in",
    res = 500)
plot(fa.parallel.withoutworry)
dev.off()
```

## EFA model fit 
EFA run for 1 to 6 factors, both with and without the worry item included. Full model with 16 items included for supplementary material. Model with 15 items presented in results. 

### 1 factor
```{r psych package EFA 1 factor}
# polycor.efa.fit1 <- psych::fa(
#                           r = polycor_matrix$correlations,
#                           nfactors = 1, #number of factors
#                           n.obs = max(polycor_matrix$n), #number of observations
#                           n.iter = 1000, #Number of bootstrap interations to do in fa
#                           rotate = "oblimin", #allows the factors to be correlated
#                           fm = "wls", #for normal data - "ml" (maximum likelihood) is preferred, if you have skewed ordinal data, "wls" (weighted least squares) is preferred
#                           scores = TRUE
#   )
# 
# #save object so no need to re-run
# saveRDS(polycor.efa.fit1, file = "../saved_r_objects/polycor.efa.fit1.rds")
polycor.efa.fit1 <- readRDS("../saved_r_objects/polycor.efa.fit1.rds")

#print the loadings for each factor
polycor.efa.fit1 
print(polycor.efa.fit1$loadings, cutoff = 0.3)
#u2 is uniqueness - unique variance
#h2 is communality - common variance 
```

### 1 factor - without worry
```{r 1b factor model} 
# polycor.efa.fit1b <- psych::fa(r = polycor_matrix.withoutworry$correlations,
#                                  nfactors = 1,
#                                  n.obs = max(polycor_matrix.withoutworry$n),
#                                  n.iter = 1000, 
#                                  rotate = "oblimin",
#                                  fm = "wls")
# 
# #save object so no need to re-run
# saveRDS(polycor.efa.fit1b, file = "../saved_r_objects/polycor.efa.fit1b.rds")
polycor.efa.fit1b <- readRDS("../saved_r_objects/polycor.efa.fit1b.rds")

polycor.efa.fit1b 
print(polycor.efa.fit1b$loadings, cutoff = 0.1)
fa.diagram(polycor.efa.fit1b)
```

### 2 factors 
```{r psych package EFA 2 factors}
# polycor.efa.fit2 <- psych::fa(
#                           r = polycor_matrix$correlations,
#                           nfactors = 2, #number of factors
#                           n.obs = max(polycor_matrix$n), #number of observations
#                           n.iter = 1000, #Number of bootstrap interations to do in fa
#                           rotate = "oblimin", #allows the factors to be correlated
#                           fm = "wls", #for normal data - "ml" (maximum likelihood) is preferred, if you have skewed ordinal data, "wls" (weighted least squares) is preferred
#                           scores = TRUE
#   )
# 
# #save object so no need to re-run
# saveRDS(polycor.efa.fit2, file = "../saved_r_objects/polycor.efa.fit2.rds")
polycor.efa.fit2 <- readRDS("../saved_r_objects/polycor.efa.fit2.rds")

#print the loadings for each factor
polycor.efa.fit2
print(polycor.efa.fit2$loadings, cutoff = 0.3)
#u2 is uniqueness - unique variance
#h2 is communality - common variance 
```

### 2 factors - without worry
```{r 2b factor model} 
# polycor.efa.fit2b <- psych::fa(r = polycor_matrix.withoutworry$correlations,
#                                  nfactors = 2,
#                                  n.obs = max(polycor_matrix.withoutworry$n),
#                                  n.iter = 1000, 
#                                  rotate = "oblimin",
#                                  fm = "wls")
# #save object so no need to re-run
# saveRDS(polycor.efa.fit2b, file = "../saved_r_objects/polycor.efa.fit2b.rds")
polycor.efa.fit2b <- readRDS("../saved_r_objects/polycor.efa.fit2b.rds")

polycor.efa.fit2b 
print(polycor.efa.fit2b$loadings, cutoff = 0.1)
fa.diagram(polycor.efa.fit2b)
```

### 3 factors
```{r psych package EFA 3 factors}
# polycor.efa.fit3 <- psych::fa(
#                           r = polycor_matrix$correlations,
#                           nfactors = 3, #number of factors
#                           n.obs = max(polycor_matrix$n), #number of observations
#                           n.iter = 1000, #Number of bootstrap interations to do in fa
#                           rotate = "oblimin", #allows the factors to be correlated
#                           fm = "wls", #for normal data - "ml" (maximum likelihood) is preferred, if you have skewed ordinal data, "wls" (weighted least squares) is preferred
#                           scores = TRUE
#   )
# 
# #save object so no need to re-run
# saveRDS(polycor.efa.fit3, file = "../saved_r_objects/polycor.efa.fit3.rds")
polycor.efa.fit3 <- readRDS("../saved_r_objects/polycor.efa.fit3.rds")

#print the loadings for each factor
polycor.efa.fit3
print(polycor.efa.fit3$loadings, cutoff = 0.3)
#u2 is uniqueness - unique variance
#h2 is communality - common variance 
```

### 3 factors - without worry
```{r 3b factor model} 
# polycor.efa.fit3b <- psych::fa(r = polycor_matrix.withoutworry$correlations,
#                                  nfactors = 3,
#                                  n.obs = max(polycor_matrix.withoutworry$n),
#                                  n.iter = 1000, 
#                                  rotate = "oblimin",
#                                  fm = "wls")

# saveRDS(polycor.efa.fit3b, file = "../saved_r_objects/polycor.efa.fit3b.rds")
polycor.efa.fit3b <- readRDS("../saved_r_objects/polycor.efa.fit3b.rds")

polycor.efa.fit3b
print(polycor.efa.fit3b$loadings, cutoff = 0.1)
fa.diagram(polycor.efa.fit3b)
```

### 4 factors
```{r psych package EFA 4 factors}
# polycor.efa.fit4 <- psych::fa(
#                           r = polycor_matrix$correlations,
#                           nfactors = 4, #number of factors
#                           n.obs = max(polycor_matrix$n), #number of observations
#                           n.iter = 1000, #Number of bootstrap interations to do in fa
#                           rotate = "oblimin", #allows the factors to be correlated
#                           fm = "wls", #for normal data - "ml" (maximum likelihood) is preferred, if you have skewed ordinal data, "wls" (weighted least squares) is preferred
#                           scores = TRUE
#   )
# 
# #save object so no need to re-run
# saveRDS(polycor.efa.fit4, file = "../saved_r_objects/polycor.efa.fit4.rds")
polycor.efa.fit4 <- readRDS("../saved_r_objects/polycor.efa.fit4.rds")

#print the loadings for each factor
polycor.efa.fit4
print(polycor.efa.fit4$loadings, cutoff = 0.3)
#u2 is uniqueness - unique variance
#h2 is communality - common variance 
fa.diagram(polycor.efa.fit4)
```

### 4 factors - without worry
```{r 4b factor model} 
# polycor.efa.fit4b <- psych::fa(r = polycor_matrix.withoutworry$correlations,
#                                  nfactors = 4,
#                                  n.obs = max(polycor_matrix.withoutworry$n),
#                                  n.iter = 1000, 
#                                  rotate = "oblimin",
#                                  fm = "wls")
# 
# #save object so no need to re-run
# saveRDS(polycor.efa.fit4b, file = "../saved_r_objects/polycor.efa.fit4b.rds")
polycor.efa.fit4b <- readRDS("../saved_r_objects/polycor.efa.fit4b.rds")

polycor.efa.fit4b
print(polycor.efa.fit4b$loadings, cutoff = 0.1)
fa.diagram(polycor.efa.fit4b)
```

### 5 factors
```{r psych package EFA 5 factors}
# polycor.efa.fit5 <- psych::fa(
#                           r = polycor_matrix$correlations,
#                           nfactors = 5, #number of factors
#                           n.obs = max(polycor_matrix$n), #number of observations
#                           n.iter = 1000, #Number of bootstrap interations to do in fa
#                           rotate = "oblimin", #allows the factors to be correlated
#                           fm = "wls", #for normal data - "ml" (maximum likelihood) is preferred, if you have skewed ordinal data, "wls" (weighted least squares) is preferred
#                           scores = TRUE
#   )
# 
# #save object so no need to re-run
# saveRDS(polycor.efa.fit5, file = "../saved_r_objects/polycor.efa.fit5.rds")
polycor.efa.fit5 <- readRDS("../saved_r_objects/polycor.efa.fit5.rds")

#print the loadings for each factor
polycor.efa.fit5
print(polycor.efa.fit5$loadings, cutoff = 0.3)
psych::fa.diagram(polycor.efa.fit5)
#u2 is uniqueness - unique variance
#h2 is communality - common variance 
```

### 5 factors - without worry
```{r 5b factor model} 
# polycor.efa.fit5b <- psych::fa(r = polycor_matrix.withoutworry$correlations,
#                                  nfactors = 5,
#                                  n.obs = max(polycor_matrix.withoutworry$n),
#                                  n.iter = 1000, 
#                                  rotate = "oblimin",
#                                  fm = "wls")
# 
# #save object so no need to re-run
# saveRDS(polycor.efa.fit5b, file = "../saved_r_objects/polycor.efa.fit5b.rds")
polycor.efa.fit5b <- readRDS("../saved_r_objects/polycor.efa.fit5b.rds")

polycor.efa.fit5b
print(polycor.efa.fit5b$loadings, cutoff = 0.1)
fa.diagram(polycor.efa.fit5b)
```

### 6 factors
```{r psych package EFA 6 factors}
# polycor.efa.fit6 <- psych::fa(
#                           r = polycor_matrix$correlations,
#                           nfactors = 6, #number of factors
#                           n.obs = max(polycor_matrix$n), #number of observations
#                           n.iter = 1000, #Number of bootstrap interations to do in fa
#                           rotate = "oblimin", #allows the factors to be correlated
#                           fm = "wls", #for normal data - "ml" (maximum likelihood) is preferred, if you have skewed ordinal data, "wls" (weighted least squares) is preferred
#                           scores = TRUE
#   )
# 
# #save object so no need to re-run
# saveRDS(polycor.efa.fit6, file = "../saved_r_objects/polycor.efa.fit6.rds")
polycor.efa.fit6 <- readRDS("../saved_r_objects/polycor.efa.fit6.rds")

#print the loadings for each factor
polycor.efa.fit6
print(polycor.efa.fit6$loadings, cutoff = 0.3)
#u2 is uniqueness - unique variance
#h2 is communality - common variance 
fa.diagram(polycor.efa.fit6)
```

### 6 factors - without worry
```{r 6b factor model} 
# polycor.efa.fit6b <- psych::fa(r = polycor_matrix.withoutworry$correlations,
#                                  nfactors = 6,
#                                  n.obs = max(polycor_matrix.withoutworry$n),
#                                  n.iter = 1000, 
#                                  rotate = "oblimin",
#                                  fm = "wls")
# 
# #save object so no need to re-run
# saveRDS(polycor.efa.fit6b, file = "../saved_r_objects/polycor.efa.fit6b.rds")
polycor.efa.fit6b <- readRDS("../saved_r_objects/polycor.efa.fit6b.rds")

polycor.efa.fit6b
print(polycor.efa.fit6b$loadings, cutoff = 0.1)
fa.diagram(polycor.efa.fit6b)
```

## Plot EFA with 4 factors - without "worrying too much" item

### Path diagram 
The EFA path diagram used in the paper will be reconstructed in Biorender to create flush labels and paths. 
```{r EFA diagram for factor 4b model - path diagram, fig.height = 3}
#name the factors
colnames(polycor.efa.fit4b$loadings) <- c("Worry symptoms",
                                          "Mood symptoms",
                                         "Somatic symptoms",
                                         "Motor symptoms")
#create diagram
library(psych)
efa_plot_withoutworry <- fa.diagram(polycor.efa.fit4b, 
           e.size = 0.05, 
           rsize = 0.4, 
           digits = 2, 
           sort = TRUE, 
           adj = 2, 
           cex = 1
          )
```

### Factor loadings diagram
```{r EFA diagram for factor 4b model}
## other fa plot 
#create data frame with loadings
loadings <- as.data.frame(unclass(polycor.efa.fit4b$loadings))
  
#create item variable         
loadings$Item <- c("Anhedonia",   #Add in the names you would like for your variables
                                 "Depressed mood", 
                                 "Sleep change", 
                                 "Little energy", 
                                 "Weight or Appetite problems",
                                 "Worthlessness", 
                                 "Concentration problems", 
                                 "Motor problems", 
                                 "Suicide ideation", 
                                 "Feeling anxious", 
                                 "Difficulty controlling worrying",
                                 "Trouble relaxing", 
                                 "Restlessness", 
                                 "Irritable", 
                                 "Feeling afraid") 
#order item variable
Order <- c("Suicide ideation", 
           "Depressed mood",
           "Worthlessness", 
           "Anhedonia",
           "Concentration problems",
           "Difficulty controlling worrying",
           "Feeling anxious", 
           "Feeling afraid",
           "Trouble relaxing",
           "Irritable",
           "Little energy",
           "Sleep change", 
            "Weight or Appetite problems",
            "Restlessness",
           "Motor problems")

loadings$Item <- factor(loadings$Item, levels = paste(Order, sep = ","))

loadings.m <- melt(loadings, id = "Item",
                   measure=c("Worry symptoms", "Mood symptoms", 
                             "Somatic symptoms", "Motor symptoms"), 
                   variable.name="Factor", value.name="Loading")


efa_plot <- ggplot(loadings.m, aes(Item, abs(Loading), fill=Loading)) + 
  facet_wrap(~ Factor, nrow = 1) + #place the factors in separate facets
  geom_bar(stat = "identity") + #make the bars
  coord_flip() + #flip the axes so the test names can be horizontal  
  #define the fill color gradient: blue=positive, red=negative
  scale_fill_gradient2(name = "Loading", 
                       high = "blue", mid = "white", low = "red", 
                       midpoint = 0, guide = F) +
  ylab("Loading Strength") + #improve y-axis label
  theme_bw(base_size = 10) #use a black-and0white theme with set font size
efa_plot

#save the plot
ggsave(
  "efa_plot.pdf",
  plot = efa_plot,
  device = "pdf",
  path = "../plots/efa/",
  width = 7,
  height = 6
)
#png
ggsave(
  "efa_plot.png",
  plot = efa_plot,
  device = "png",
  path = "../plots/efa/",
  width = 7,
  height = 6
)
#jpeg
ggsave(
  "efa_plot.jpeg",
  plot = efa_plot,
  device = "jpeg",
  path = "../plots/efa/",
  width = 7,
  height = 6
)
```

### EFA panel factor loadings plot with blank space for Biorender plot to be added in 

```{r combined efa plot}
library(ggplot2)
efa_plot_combined <- ggarrange(efa_plot_withoutworry, efa_plot  + font("x.text", size = 10),
                    ncol = 2, nrow = 1, labels = c("A", "B"))

efa_plot_combined

#save the plot
ggsave(
  "efa.final_template.pdf",
  plot = efa_plot_combined,
  device = "pdf",
  path = "../plots/efa/",
  width = 14,
  height = 6
)
#png
ggsave(
  "efa.final_template.png",
  plot = efa_plot_combined,
  device = "png",
  path = "../plots/efa/",
  width = 14,
  height = 6
)
#jpeg
ggsave(
  "efa.final_template.jpeg",
  plot = efa_plot_combined,
  device = "jpeg",
  path = "../plots/efa/",
  width = 14,
  height = 6
)
```

# **Sensitivity analysis: EFA with concentration problems dropped**

## Polychoric correlation matrix without concentration item
```{r polycor matrix without concentration}
#create dataframe without worry and concentration items
ALL.items.full.df.withoutconcentration <- as.data.frame(exploratory.group [,ALL.items.full.withoutconcentration])

is.data.frame(ALL.items.full.df.withoutconcentration) #check that it is a dataframe
#list the column names to be used in the dataframe
colnames(ALL.items.full.df.withoutconcentration) <- c("Anhedonia", 
                                                    "Depressed mood", 
                                                    "Sleep change", 
                                                    "Little energy", 
                                                    "Weight or Appetite problems", 
                                                    "Worthlessness", 
                                                    "Motor problems", 
                                                    "Suicide ideation", 
                                                    "Feeling anxious", 
                                                    "Difficulty controlling worrying", 
                                                    "Trouble relaxing", 
                                                    "Restlessness", 
                                                    "Irritable", 
                                                    "Feeling afraid")
ALL.items.full.df.withoutconcentration

# #create correlation matrix for dataframe without worry and concentration items
# polycor_matrix.withoutconcentration <- polycor::hetcor(ALL.items.full.df.withoutconcentration,
#                                              #  ML = TRUE,
#                                                use = "pairwise.complete.obs",
#                                                digits = 2)
# 
# #save object so no need to re-run
# saveRDS(polycor_matrix.withoutconcentration, file = "../saved_r_objects/polycor_matrix.withoutconcentration.rds")
polycor_matrix.withoutconcentration <- readRDS("../saved_r_objects/polycor_matrix.withoutconcentration.rds")

polycor_matrix.withoutconcentration
```

##  EFA without worry and concentration item
```{r efa without worry and concentration item}
# polycor.efa.fit4b.without_concentration <- psych::fa(r = polycor_matrix.withoutconcentration$correlations,
#                                  nfactors = 4,
#                                  n.obs = max(polycor_matrix.withoutconcentration$n),
#                                  n.iter = 1000, 
#                                  rotate = "oblimin",
#                                  fm = "wls")
# 
# #save object so no need to re-run
# saveRDS(polycor.efa.fit4b.without_concentration, file = "../saved_r_objects/polycor.efa.fit4b.without_concentration.rds")
polycor.efa.fit4b.without_concentration <- readRDS("../saved_r_objects/polycor.efa.fit4b.without_concentration.rds")


polycor.efa.fit4b.without_concentration
print(polycor.efa.fit4b.without_concentration$loadings, cutoff = 0.1)
fa.diagram(polycor.efa.fit4b.without_concentration)
```

# **Sensitivity analysis: EFA with concentration problems and irritability dropped**
## Polychoric correlation matrix without concentration AND irritability items
```{r polycor matrix without concentration and irritability}
#create dataframe without worry, concentration and irritability items
ALL.items.full.df.withoutirritability <- as.data.frame(exploratory.group [,ALL.items.full.withoutirritability])

is.data.frame(ALL.items.full.df.withoutirritability) #check that it is a dataframe
#list the column names to be used in the dataframe
colnames(ALL.items.full.df.withoutirritability) <- c("Anhedonia", 
                                                    "Depressed mood", 
                                                    "Sleep change", 
                                                    "Little energy", 
                                                    "Weight or Appetite problems", 
                                                    "Worthlessness", 
                                                    "Motor problems", 
                                                    "Suicide ideation", 
                                                    "Feeling anxious", 
                                                    "Difficulty controlling worrying", 
                                                    "Trouble relaxing", 
                                                    "Restlessness",
                                                    "Feeling afraid")
ALL.items.full.df.withoutirritability

# #create correlation matrix for dataframe without worry and concentration items
# polycor_matrix.withoutirritability <- polycor::hetcor(ALL.items.full.df.withoutirritability,
#                                              #  ML = TRUE,
#                                                use = "pairwise.complete.obs",
#                                                digits = 2)
# 
# #save object so no need to re-run
# saveRDS(polycor_matrix.withoutirritability, file = "../saved_r_objects/polycor_matrix.withoutirritability.rds")
polycor_matrix.withoutirritability <- readRDS("../saved_r_objects/polycor_matrix.withoutirritability.rds")

polycor_matrix.withoutirritability
```

## Run EFA without worry, concentration and irritability item
```{r efa without worry,concentration and irritability item}
# polycor.efa.fit4b.without_irritability <- psych::fa(r = polycor_matrix.withoutirritability$correlations,
#                                  nfactors = 4,
#                                  n.obs = max(polycor_matrix.withoutirritability$n),
#                                  n.iter = 1000, 
#                                  rotate = "oblimin",
#                                  fm = "wls")
# 
# #save object so no need to re-run
# saveRDS(polycor.efa.fit4b.without_irritability, file = "../saved_r_objects/polycor.efa.fit4b.without_irritability.rds")
polycor.efa.fit4b.without_irritability <- readRDS("../saved_r_objects/polycor.efa.fit4b.without_irritability.rds")

polycor.efa.fit4b.without_irritability
print(polycor.efa.fit4b.without_irritability$loadings, cutoff = 0.1)
fa.diagram(polycor.efa.fit4b.without_irritability)
```

**Comments: Decided that excluding both concentration problems does not improve fit.**

# **Sensitivity analysis: Rerun 4 factor model (without worry) in males and females separately**
## Polychoric matrix for females 
```{r polycor matrix for females}
#create dataframe without worry item
ALL.items.full.df.withoutworry.female <- as.data.frame(data.female [,ALL.items.full.withoutworry])

is.data.frame(ALL.items.full.df.withoutworry.female) #check that it is a dataframe
#list the column names to be used in the dataframe
colnames(ALL.items.full.df.withoutworry.female) <- c("Anhedonia", 
                                                    "Depressed mood", 
                                                    "Sleep change", 
                                                    "Little energy", 
                                                    "Weight or Appetite problems", 
                                                    "Worthlessness", 
                                                    "Concentration problems", 
                                                    "Motor problems", 
                                                    "Suicide ideation", 
                                                    "Feeling anxious", 
                                                    "Difficulty controlling worrying", 
                                                    "Trouble relaxing", 
                                                    "Restlessness", 
                                                    "Irritable", 
                                                    "Feeling afraid")
ALL.items.full.df.withoutworry.female

# #create correlation matrix for dataframe without worry item
# polycor_matrix.withoutworry.female <- polycor::hetcor(ALL.items.full.df.withoutworry.female,
#                                              #  ML = TRUE,
#                                                use = "pairwise.complete.obs",
#                                                digits = 2)
# 
# #save object so no need to re-run
# saveRDS(polycor_matrix.withoutworry.female, file = "../saved_r_objects/polycor_matrix.withoutworry.female.rds")
polycor_matrix.withoutworry.female <- readRDS("../saved_r_objects/polycor_matrix.withoutworry.female.rds")

polycor_matrix.withoutworry.female
```

## Polychoric matrix for males 
```{r polycor matrix for males}
#create dataframe without worry item
ALL.items.full.df.withoutworry.male <- as.data.frame(data.male [,ALL.items.full.withoutworry])

is.data.frame(ALL.items.full.df.withoutworry.male) #check that it is a dataframe
#list the column names to be used in the dataframe
colnames(ALL.items.full.df.withoutworry.male) <- c("Anhedonia", 
                                                  "Depressed mood", 
                                                  "Sleep change", 
                                                  "Little energy", 
                                                  "Weight or Appetite problems", 
                                                  "Worthlessness", 
                                                  "Concentration problems", 
                                                  "Motor problems", 
                                                  "Suicide ideation", 
                                                  "Feeling anxious", 
                                                  "Difficulty controlling worrying", 
                                                  "Trouble relaxing", 
                                                  "Restlessness", 
                                                  "Irritable", 
                                                  "Feeling afraid")
ALL.items.full.df.withoutworry.male

# #create correlation matrix for dataframe without worry item
# polycor_matrix.withoutworry.male <- polycor::hetcor(ALL.items.full.df.withoutworry.male,
#                                              #  ML = TRUE,
#                                                use = "pairwise.complete.obs",
#                                                digits = 2)
# #save object so no need to re-run
# saveRDS(polycor_matrix.withoutworry.male, file = "../saved_r_objects/polycor_matrix.withoutworry.male.rds")
polycor_matrix.withoutworry.male <- readRDS("../saved_r_objects/polycor_matrix.withoutworry.male.rds")

polycor_matrix.withoutworry.male
```

## Run EFA for males and females separately
```{r efa for males and females separately}
# #females
# polycor.efa.fit4b.female <- psych::fa(r = polycor_matrix.withoutworry.female$correlations,
#                                  nfactors = 4,
#                                  n.obs = max(polycor_matrix.withoutworry.female$n),
#                                  n.iter = 1000, 
#                                  rotate = "oblimin",
#                                  fm = "wls")
# 
# #save object so no need to re-run
# saveRDS(polycor.efa.fit4b.female, file = "../saved_r_objects/polycor.efa.fit4b.female.rds")
polycor.efa.fit4b.female <- readRDS("../saved_r_objects/polycor.efa.fit4b.female.rds")

polycor.efa.fit4b.female
print(polycor.efa.fit4b.female$loadings, cutoff = 0.1)
fa.diagram(polycor.efa.fit4b.female,
           e.size = 0.05, 
           rsize = 0.4, 
           digits = 2, 
           sort = TRUE, 
           adj = 2, 
           cex = 1)

# #males
# polycor.efa.fit4b.male <- psych::fa(r = polycor_matrix.withoutworry.male$correlations,
#                                  nfactors = 4,
#                                  n.obs = max(polycor_matrix.withoutworry.male$n),
#                                  n.iter = 1000, 
#                                  rotate = "oblimin",
#                                  fm = "wls")
# 
# #save object so no need to re-run
# saveRDS(polycor.efa.fit4b.male, file = "../saved_r_objects/polycor.efa.fit4b.male.rds")
polycor.efa.fit4b.male <- readRDS("../saved_r_objects/polycor.efa.fit4b.male.rds")

polycor.efa.fit4b.male
print(polycor.efa.fit4b.male$loadings, cutoff = 0.1)
fa.diagram(polycor.efa.fit4b.male,
           e.size = 0.05, 
           rsize = 0.4, 
           digits = 2, 
           sort = TRUE, 
           adj = 2, 
           cex = 1)
```

```{r efa plot in males and females}
library(ggplot2)
efa_plot_male_female <- ggarrange(efa_plot_withoutworry,  #used to create a blank panel plot to add biorender graphs over the top for paper.
                                  efa_plot_withoutworry  + 
                                    font("x.text", 
                                         size = 10),
                                  ncol = 2, 
                                  nrow = 1, 
                                  labels = c("A", "B"))

efa_plot_male_female

#save the plot
ggsave(
  "efa_plot_male_female.template.pdf",
  plot = efa_plot_male_female,
  device = "pdf",
  path = "../plots/efa/",
  width = 14,
  height = 6
)
#png
ggsave(
  "efa_plot_male_female.template.png",
  plot = efa_plot_male_female,
  device = "png",
  path = "../plots/efa/",
  width = 14,
  height = 6
)
#jpeg
ggsave(
  "efa_plot_male_female.template.jpeg",
  plot = efa_plot_male_female,
  device = "jpeg",
  path = "../plots/efa/",
  width = 14,
  height = 6
)
```

# **Confirmatory factor analysis (CFA)**
**Used the 4b factor model (without worry item) from the EFA to replicate in the remaining 30% of the sample.** 

## **CHOSEN** 4b factor model
### Define **CHOSEN** latent factors for 4 factor model - without worry item 
```{r define cfa model based on cfa 4b fatcor model}
cfa.model4b <- 'worry =~ 
              gad.control_worrying_numeric + 
              gad.feeling_anxious_numeric + 
              gad.feeling_afraid_numeric + 
              gad.trouble_relaxing_numeric + 
              gad.irritable_numeric

              mood =~ phq.depressed_mood_numeric + 
              phq.suicide_ideation_numeric + 
              phq.anhedonia_numeric + 
              phq.worthlessness_numeric + 
              phq.concentration_problems_numeric

              somatic =~ phq.little_energy_numeric + 
              phq.sleep_change_numeric + 
              phq.eating_problems_numeric 

              motor =~ gad.restless_numeric + 
              phq.motor_problems_numeric 
              '
```

### Run the CFA for the 4b factor model - without worry
```{r run 4b cfa}
cfa.model4b.fit <- cfa(cfa.model4b, 
                      data = confirmatory.group, 
                      ordered = c("phq.anhedonia_numeric",
                                   "phq.depressed_mood_numeric",
                                   "phq.sleep_change_numeric",
                                   "phq.little_energy_numeric",
                                   "phq.eating_problems_numeric",
                                   "phq.worthlessness_numeric",
                                   "phq.concentration_problems_numeric",
                                   "phq.motor_problems_numeric",
                                   "phq.suicide_ideation_numeric",
                                   "gad.feeling_anxious_numeric",
                                   "gad.control_worrying_numeric",
                                   "gad.trouble_relaxing_numeric", 
                                   "gad.restless_numeric", 
                                   "gad.irritable_numeric",
                                   "gad.feeling_afraid_numeric"))
```

### Summary stats for the 4b factor model - without worry
```{r fit statistics for cfa 4b}
summary(cfa.model4b.fit, fit.measures = TRUE)
```

# **Rerun CHOSEN CFA 4b model (without worry) in the whole sample to create factor scores for all participants.** 

```{r finalised cfa}
#Define model - here have taken the full 4 factor model
cfa.model.final <- 'worry =~ 
              gad.control_worrying_numeric + 
              gad.feeling_anxious_numeric + 
              gad.feeling_afraid_numeric + 
              gad.trouble_relaxing_numeric + 
              gad.irritable_numeric

              mood =~ phq.depressed_mood_numeric + 
              phq.suicide_ideation_numeric + 
              phq.anhedonia_numeric + 
              phq.worthlessness_numeric + 
              phq.concentration_problems_numeric

              somatic =~ phq.little_energy_numeric + 
              phq.sleep_change_numeric + 
              phq.eating_problems_numeric 

              motor =~ gad.restless_numeric + 
              phq.motor_problems_numeric 
              '
#run cfa for this model in whole sample
cfa.model.fit.final <- cfa(cfa.model.final, 
                      data = dat, 
                      ordered = c("phq.anhedonia_numeric",
                                   "phq.depressed_mood_numeric",
                                   "phq.sleep_change_numeric",
                                   "phq.little_energy_numeric",
                                   "phq.eating_problems_numeric",
                                   "phq.worthlessness_numeric",
                                   "phq.concentration_problems_numeric",
                                   "phq.motor_problems_numeric",
                                   "phq.suicide_ideation_numeric",
                                   "gad.feeling_anxious_numeric",
                                   "gad.control_worrying_numeric",
                                   "gad.trouble_relaxing_numeric", 
                                   "gad.restless_numeric", 
                                   "gad.irritable_numeric",
                                   "gad.feeling_afraid_numeric"))

summary(cfa.model.fit.final, fit.measures = TRUE)
```

# **Factor Scores**
Use the CFA to create factor scores for each participant -using the final cfa model
```{r calculating factor scores for full model}
# factor_scores <- lavPredict(
#   object = cfa.model.fit.final, # model of the original CFA
#   newdata = dat, # data frame with the whole data
#   type = "fy",
#   method = "ML", # "EBM" Empirical Bayes Model or "ML" maximum likelihood are suggested for ordinal data
# #  se = "standard", # standard standard errors are calculated
#   label = TRUE,
#   ETA = ALL.items.full.withoutworry
#  # append.data = TRUE # append data frame and factor scores
#   )

# #save object so no need to re-run
# saveRDS(factor_scores, file = "../saved_r_objects/factor_scores.rds")
factor_scores <- readRDS("../saved_r_objects/factor_scores.rds")

dim(factor_scores)
head(factor_scores)

describe(factor_scores)
```

Bind the factor scores to the dataframe
```{r bind the factor scores to the dataframe}
dat <- cbind(
  dat, 
  factor_scores)
```

# **Age and sex-related variability in the presentation of PHQ and GAD items**

### Create age/10 variable 
```{r divide age by 10}
#this makes the OR more interpretable as you think of increase/decrease per 10 years rather than per year
dat <- dat %>%
  mutate(
    age_divided = 
      (age)/10
  )
colnames(dat)
```

## Linear regressions for age and PHQ-GAD sum scores
```{r linear regressions for sum scores}
#PHQ
PHQ.total.score.model <- lm(PHQ.total.score ~ age_divided + sex, data = dat)
summary(PHQ.total.score.model)
 
#GAD
GAD.total.score.model <- lm(GAD.total.score ~ age_divided + sex, data = dat)
summary(GAD.total.score.model)
```

## Logistic regressions for age
### Logistic regressions for PHQ items - age divided, sex, PHQ total score, GAD total score 
```{r logistic regressions for phq items}
##Anhedonia - this regression is done step by step and annotated to show what each part of the code is doing (the rest wont be annotated)
#run logistic regression for anhedonia
log.phq.anhedonia <- glm(phq.anhedonia.cat ~ age_divided + sex + PHQ.total.score + GAD.total.score, data = dat, family = "binomial")
summary(log.phq.anhedonia) #look at the summary of this regression
#create tidy table of regression estimates, statistic and confidence intervals 
CI.log.anhedonia <- tidy(log.phq.anhedonia, 
                         conf.int = TRUE, 
                         exponantiate = TRUE)
#Add column to indicate which symptom these statistics are for 
CI.log.anhedonia <- add_column(CI.log.anhedonia, 
                                symptom = "Anhedonia")
#Get Odds Ratios for the logistic regression
OR.log.anhedonia <- exp(coef(log.phq.anhedonia)) 
#Get Confidence intervals for the logistic regression
OR.CI.log.anhedonia <- exp(confint(log.phq.anhedonia))
#Add the OR into a new column 
CI.log.anhedonia <- add_column(CI.log.anhedonia, OR = OR.log.anhedonia)
CI.log.anhedonia #have a look at the table
#Add the lower CI for OR into a new column - using all rows and the first column of the confidence interval statistics object
CI.log.anhedonia <- add_column(CI.log.anhedonia, OR.CI.lower = OR.CI.log.anhedonia[,1])
#Add the upper CI for OR into a new column - using all rows and the second column of the confidence interval statistics object
CI.log.anhedonia <- add_column(CI.log.anhedonia, OR.CI.upper = OR.CI.log.anhedonia[,2])
CI.log.anhedonia #have a look at the table that's been created
#create table with just age statistics - row 2 and columns 1 to 11 of our original table
CI.log.anhedonia.age <- CI.log.anhedonia[2,1:11]
CI.log.anhedonia.age #have a look at the table to get the statistics you need
#create table with just sex statistics - row 3 and columns 1 to 11 of our original table
CI.log.anhedonia.sex <- CI.log.anhedonia[3,1:11]
CI.log.anhedonia.sex #have a look at the table to get the statistics you need

#Depressed mood
log.phq.depressed_mood <- glm(phq.depressed_mood.cat ~ age_divided + sex + PHQ.total.score + GAD.total.score, data = dat, family = "binomial")
summary(log.phq.depressed_mood)
CI.log.depressed_mood <- tidy(log.phq.depressed_mood, conf.int = TRUE, exponantiate = TRUE)
CI.log.depressed_mood <- add_column(CI.log.depressed_mood, 
  symptom = "Depressed mood")
OR.log.depressed_mood <- exp(coef(log.phq.depressed_mood)) 
OR.CI.log.depressed_mood <- exp(confint(log.phq.depressed_mood))
CI.log.depressed_mood <- add_column(CI.log.depressed_mood, OR = OR.log.depressed_mood)
CI.log.depressed_mood <- add_column(CI.log.depressed_mood, OR.CI.lower = OR.CI.log.depressed_mood[,1])
CI.log.depressed_mood <- add_column(CI.log.depressed_mood, OR.CI.upper = OR.CI.log.depressed_mood[,2])
CI.log.depressed_mood 
CI.log.depressed_mood.age <- CI.log.depressed_mood[2,1:11]
CI.log.depressed_mood.age
CI.log.depressed_mood.sex <- CI.log.depressed_mood[3,1:11]
CI.log.depressed_mood.sex

#Sleep change
log.phq.sleep_change <- glm(phq.sleep_change.cat ~ age_divided + sex + PHQ.total.score + GAD.total.score, data = dat, family = "binomial")
summary(log.phq.sleep_change)
CI.log.sleep_change <- tidy(log.phq.sleep_change, conf.int = TRUE, exponantiate = TRUE)
CI.log.sleep_change <- add_column(CI.log.sleep_change, 
  symptom = "Sleep change")
OR.log.sleep_change <- exp(coef(log.phq.sleep_change)) 
OR.CI.log.sleep_change <- exp(confint(log.phq.sleep_change))
CI.log.sleep_change <- add_column(CI.log.sleep_change, OR = OR.log.sleep_change)
CI.log.sleep_change <- add_column(CI.log.sleep_change, OR.CI.lower = OR.CI.log.sleep_change[,1])
CI.log.sleep_change <- add_column(CI.log.sleep_change, OR.CI.upper = OR.CI.log.sleep_change[,2])
CI.log.sleep_change 
CI.log.sleep_change.age <- CI.log.sleep_change[2,1:11]
CI.log.sleep_change.age
CI.log.sleep_change.sex <- CI.log.sleep_change[3,1:11]
CI.log.sleep_change.sex

#Little energy 
log.phq.little_energy <- glm(phq.little_energy.cat ~ age_divided + sex + PHQ.total.score + GAD.total.score, data = dat, family = "binomial")
summary(log.phq.little_energy)
CI.log.little_energy <- tidy(log.phq.little_energy, conf.int = TRUE, exponantiate = TRUE)
CI.log.little_energy <- add_column(CI.log.little_energy, 
  symptom = "Little energy")
OR.log.little_energy <- exp(coef(log.phq.little_energy)) 
OR.CI.log.little_energy <- exp(confint(log.phq.little_energy))
CI.log.little_energy <- add_column(CI.log.little_energy, OR = OR.log.little_energy)
CI.log.little_energy <- add_column(CI.log.little_energy, OR.CI.lower = OR.CI.log.little_energy[,1])
CI.log.little_energy <- add_column(CI.log.little_energy, OR.CI.upper = OR.CI.log.little_energy[,2])
CI.log.little_energy 
CI.log.little_energy.age <- CI.log.little_energy[2,1:11]
CI.log.little_energy.age
CI.log.little_energy.sex <- CI.log.little_energy[3,1:11]
CI.log.little_energy.sex

#Weight or appetite problems
log.phq.eating_problems <- glm(phq.eating_problems.cat ~ age_divided + sex + PHQ.total.score + GAD.total.score, data = dat, family = "binomial")
summary(log.phq.eating_problems)
CI.log.eating_problems <- tidy(log.phq.eating_problems, conf.int = TRUE, exponantiate = TRUE)
CI.log.eating_problems <- add_column(CI.log.eating_problems, 
  symptom = "Weight or appetite problems")
OR.log.eating_problems <- exp(coef(log.phq.eating_problems)) 
OR.CI.log.eating_problems <- exp(confint(log.phq.eating_problems))
CI.log.eating_problems <- add_column(CI.log.eating_problems, OR = OR.log.eating_problems)
CI.log.eating_problems <- add_column(CI.log.eating_problems, OR.CI.lower = OR.CI.log.eating_problems[,1])
CI.log.eating_problems <- add_column(CI.log.eating_problems, OR.CI.upper = OR.CI.log.eating_problems[,2])
CI.log.eating_problems 
CI.log.eating_problems.age <- CI.log.eating_problems[2,1:11]
CI.log.eating_problems.age
CI.log.eating_problems.sex <- CI.log.eating_problems[3,1:11]
CI.log.eating_problems.sex

#Worthlessness
log.phq.worthlessness <- glm(phq.worthlessness.cat ~ age_divided + sex + PHQ.total.score + GAD.total.score, data = dat, family = "binomial")
summary(log.phq.worthlessness)
CI.log.worthlessness <- tidy(log.phq.worthlessness, conf.int = TRUE, exponantiate = TRUE)
CI.log.worthlessness <- add_column(CI.log.worthlessness, 
  symptom = "Worthlessness")
OR.log.worthlessness <- exp(coef(log.phq.worthlessness)) 
OR.CI.log.worthlessness <- exp(confint(log.phq.worthlessness))
CI.log.worthlessness <- add_column(CI.log.worthlessness, OR = OR.log.worthlessness)
CI.log.worthlessness <- add_column(CI.log.worthlessness, OR.CI.lower = OR.CI.log.worthlessness[,1])
CI.log.worthlessness <- add_column(CI.log.worthlessness, OR.CI.upper = OR.CI.log.worthlessness[,2])
CI.log.worthlessness 
CI.log.worthlessness.age <- CI.log.worthlessness[2,1:11]
CI.log.worthlessness.age
CI.log.worthlessness.sex <- CI.log.worthlessness[3,1:11]
CI.log.worthlessness.sex

#Concentration problems
log.phq.concentration_problems <- glm(phq.concentration_problems.cat ~ age_divided + sex + PHQ.total.score + GAD.total.score, data = dat, family = "binomial")
summary(log.phq.concentration_problems)
CI.log.concentration_problems <- tidy(log.phq.concentration_problems, conf.int = TRUE, exponantiate = TRUE)
CI.log.concentration_problems <- add_column(CI.log.concentration_problems, 
  symptom = "Concentration problems")
OR.log.concentration_problems <- exp(coef(log.phq.concentration_problems)) 
OR.CI.log.concentration_problems <- exp(confint(log.phq.concentration_problems))
CI.log.concentration_problems <- add_column(CI.log.concentration_problems, OR = OR.log.concentration_problems)
CI.log.concentration_problems <- add_column(CI.log.concentration_problems, OR.CI.lower = OR.CI.log.concentration_problems[,1])
CI.log.concentration_problems <- add_column(CI.log.concentration_problems, OR.CI.upper = OR.CI.log.concentration_problems[,2])
CI.log.concentration_problems 
CI.log.concentration_problems.age <- CI.log.concentration_problems[2,1:11]
CI.log.concentration_problems.age
CI.log.concentration_problems.sex <- CI.log.concentration_problems[3,1:11]
CI.log.concentration_problems.sex

#Motor problems
log.phq.motor_problems <- glm(phq.motor_problems.cat ~ age_divided + sex + PHQ.total.score + GAD.total.score, data = dat, family = "binomial")
summary(log.phq.motor_problems)
CI.log.motor_problems <- tidy(log.phq.motor_problems, conf.int = TRUE, exponantiate = TRUE)
CI.log.motor_problems <- add_column(CI.log.motor_problems, 
  symptom = "Motor problems")
OR.log.motor_problems <- exp(coef(log.phq.motor_problems)) 
OR.CI.log.motor_problems <- exp(confint(log.phq.motor_problems))
CI.log.motor_problems <- add_column(CI.log.motor_problems, OR = OR.log.motor_problems)
CI.log.motor_problems <- add_column(CI.log.motor_problems, OR.CI.lower = OR.CI.log.motor_problems[,1])
CI.log.motor_problems <- add_column(CI.log.motor_problems, OR.CI.upper = OR.CI.log.motor_problems[,2])
CI.log.motor_problems 
CI.log.motor_problems.age <- CI.log.motor_problems[2,1:11]
CI.log.motor_problems.age
CI.log.motor_problems.sex <- CI.log.motor_problems[3,1:11]
CI.log.motor_problems.sex

#Suicide ideation
log.phq.suicide_ideation <- glm(phq.suicide_ideation.cat ~ age_divided + sex + PHQ.total.score + GAD.total.score, data = dat, family = "binomial")
summary(log.phq.suicide_ideation)
CI.log.suicide_ideation <- tidy(log.phq.suicide_ideation, conf.int = TRUE, exponantiate = TRUE)
CI.log.suicide_ideation <- add_column(CI.log.suicide_ideation, 
  symptom = "Suicide ideation")
OR.log.suicide_ideation <- exp(coef(log.phq.suicide_ideation)) 
OR.CI.log.suicide_ideation <- exp(confint(log.phq.suicide_ideation))
CI.log.suicide_ideation <- add_column(CI.log.suicide_ideation, OR = OR.log.suicide_ideation)
CI.log.suicide_ideation <- add_column(CI.log.suicide_ideation, OR.CI.lower = OR.CI.log.suicide_ideation[,1])
CI.log.suicide_ideation <- add_column(CI.log.suicide_ideation, OR.CI.upper = OR.CI.log.suicide_ideation[,2])
CI.log.suicide_ideation 
CI.log.suicide_ideation.age <- CI.log.suicide_ideation[2,1:11]
CI.log.suicide_ideation.age
CI.log.suicide_ideation.sex <- CI.log.suicide_ideation[3,1:11]
CI.log.suicide_ideation.sex

```

Join table rows together from the PHQ regression stats 
```{r join datasets to make forest plot}
#bind all the PHQ/age rows together
ALL_CI_PHQ.age <- bind_rows(CI.log.anhedonia.age, 
                            CI.log.depressed_mood.age, 
                            CI.log.sleep_change.age, 
                            CI.log.little_energy.age, 
                            CI.log.eating_problems.age, 
                            CI.log.worthlessness.age, 
                            CI.log.concentration_problems.age, 
                            CI.log.motor_problems.age, 
                            CI.log.suicide_ideation.age)
#add a column to show the disorder
ALL_CI_PHQ.age <- add_column(ALL_CI_PHQ.age, disorder = "MDD")
ALL_CI_PHQ.age #have a look at the table

#bind all the PHQ/sex rows together
ALL_CI_PHQ.sex <- bind_rows(CI.log.anhedonia.sex, 
                            CI.log.depressed_mood.sex, 
                            CI.log.sleep_change.sex, 
                            CI.log.little_energy.sex, 
                            CI.log.eating_problems.sex, 
                            CI.log.worthlessness.sex, 
                            CI.log.concentration_problems.sex, 
                            CI.log.motor_problems.sex, 
                            CI.log.suicide_ideation.sex)
#add a column to show the disorder
ALL_CI_PHQ.sex <- add_column(ALL_CI_PHQ.sex, disorder = "MDD")
ALL_CI_PHQ.sex #have a look at the table
```

### Logistic regression for GAD items - age divided, sex, PHQ total score, GAD total score 
```{r logistic regressions for gad}
log.gad.feeling_anxious <- glm(gad.feeling_anxious.cat ~ age_divided + sex + PHQ.total.score + GAD.total.score, data = dat, family = "binomial")
summary(log.gad.feeling_anxious)
CI.log.feeling_anxious <- tidy(log.gad.feeling_anxious, conf.int = TRUE, exponantiate = TRUE)
CI.log.feeling_anxious <- add_column(CI.log.feeling_anxious, 
  symptom = "Feeling anxious")
OR.log.feeling_anxious <- exp(coef(log.gad.feeling_anxious)) 
OR.CI.log.feeling_anxious <- exp(confint(log.gad.feeling_anxious))
CI.log.feeling_anxious <- add_column(CI.log.feeling_anxious, OR = OR.log.feeling_anxious)
CI.log.feeling_anxious <- add_column(CI.log.feeling_anxious, OR.CI.lower = OR.CI.log.feeling_anxious[,1])
CI.log.feeling_anxious <- add_column(CI.log.feeling_anxious, OR.CI.upper = OR.CI.log.feeling_anxious[,2])
CI.log.feeling_anxious 
CI.log.feeling_anxious.age <- CI.log.feeling_anxious[2,1:11]
CI.log.feeling_anxious.age
CI.log.feeling_anxious.sex <- CI.log.feeling_anxious[3,1:11]
CI.log.feeling_anxious.sex


log.gad.control_worrying <- glm(gad.control_worrying.cat ~ age_divided + sex + PHQ.total.score + GAD.total.score, data = dat, family = "binomial")
summary(log.gad.control_worrying)
CI.log.control_worrying <- tidy(log.gad.control_worrying, conf.int = TRUE, exponantiate = TRUE)
CI.log.control_worrying <- add_column(CI.log.control_worrying, 
  symptom = "Difficulty controlling worrying")
OR.log.control_worrying <- exp(coef(log.gad.control_worrying)) 
OR.CI.log.control_worrying <- exp(confint(log.gad.control_worrying))
CI.log.control_worrying <- add_column(CI.log.control_worrying, OR = OR.log.control_worrying)
CI.log.control_worrying <- add_column(CI.log.control_worrying, OR.CI.lower = OR.CI.log.control_worrying[,1])
CI.log.control_worrying <- add_column(CI.log.control_worrying, OR.CI.upper = OR.CI.log.control_worrying[,2])
CI.log.control_worrying 
CI.log.control_worrying.age <- CI.log.control_worrying[2,1:11]
CI.log.control_worrying.age
CI.log.control_worrying.sex <- CI.log.control_worrying[3,1:11]
CI.log.control_worrying.sex

log.gad.worry_toomuch <- glm(gad.worry_toomuch.cat ~ age_divided + sex + PHQ.total.score + GAD.total.score, data = dat, family = "binomial")
summary(log.gad.worry_toomuch)
CI.log.worry_toomuch <- tidy(log.gad.worry_toomuch, conf.int = TRUE, exponantiate = TRUE)
CI.log.worry_toomuch <- add_column(CI.log.worry_toomuch, 
  symptom = "Worrying too much")
OR.log.worry_toomuch <- exp(coef(log.gad.worry_toomuch)) 
OR.CI.log.worry_toomuch <- exp(confint(log.gad.worry_toomuch))
CI.log.worry_toomuch <- add_column(CI.log.worry_toomuch, OR = OR.log.worry_toomuch)
CI.log.worry_toomuch <- add_column(CI.log.worry_toomuch, OR.CI.lower = OR.CI.log.worry_toomuch[,1])
CI.log.worry_toomuch <- add_column(CI.log.worry_toomuch, OR.CI.upper = OR.CI.log.worry_toomuch[,2])
CI.log.worry_toomuch 
CI.log.worry_toomuch.age <- CI.log.worry_toomuch[2,1:11]
CI.log.worry_toomuch.age
CI.log.worry_toomuch.sex <- CI.log.worry_toomuch[3,1:11]
CI.log.worry_toomuch.sex

log.gad.trouble_relaxing <- glm(gad.trouble_relaxing.cat ~ age_divided + sex + PHQ.total.score + GAD.total.score, data = dat, family = "binomial")
summary(log.gad.trouble_relaxing)
CI.log.trouble_relaxing <- tidy(log.gad.trouble_relaxing, conf.int = TRUE, exponantiate = TRUE)
CI.log.trouble_relaxing <- add_column(CI.log.trouble_relaxing, 
  symptom = "Trouble relaxing")
OR.log.trouble_relaxing <- exp(coef(log.gad.trouble_relaxing)) 
OR.CI.log.trouble_relaxing <- exp(confint(log.gad.trouble_relaxing))
CI.log.trouble_relaxing <- add_column(CI.log.trouble_relaxing, OR = OR.log.trouble_relaxing)
CI.log.trouble_relaxing <- add_column(CI.log.trouble_relaxing, OR.CI.lower = OR.CI.log.trouble_relaxing[,1])
CI.log.trouble_relaxing <- add_column(CI.log.trouble_relaxing, OR.CI.upper = OR.CI.log.trouble_relaxing[,2])
CI.log.trouble_relaxing 
CI.log.trouble_relaxing.age <- CI.log.trouble_relaxing[2,1:11]
CI.log.trouble_relaxing.age
CI.log.trouble_relaxing.sex <- CI.log.trouble_relaxing[3,1:11]
CI.log.trouble_relaxing.sex


log.gad.restless <- glm(gad.restless.cat ~ age_divided + sex + PHQ.total.score + GAD.total.score, data = dat, family = "binomial")
summary(log.gad.restless)
CI.log.restless <- tidy(log.gad.restless, conf.int = TRUE, exponantiate = TRUE)
CI.log.restless <- add_column(CI.log.restless, 
  symptom = "Restlessness")
OR.log.restless <- exp(coef(log.gad.restless)) 
OR.CI.log.restless <- exp(confint(log.gad.restless))
CI.log.restless <- add_column(CI.log.restless, OR = OR.log.restless)
CI.log.restless <- add_column(CI.log.restless, OR.CI.lower = OR.CI.log.restless[,1])
CI.log.restless <- add_column(CI.log.restless, OR.CI.upper = OR.CI.log.restless[,2])
CI.log.restless 
CI.log.restless.age <- CI.log.restless[2,1:11]
CI.log.restless.age
CI.log.restless.sex <- CI.log.restless[3,1:11]
CI.log.restless.sex

log.gad.irritable <- glm(gad.irritable.cat ~ age_divided + sex + PHQ.total.score + GAD.total.score, data = dat, family = "binomial")
summary(log.gad.irritable)
CI.log.irritable <- tidy(log.gad.irritable, conf.int = TRUE, exponantiate = TRUE)
CI.log.irritable <- add_column(CI.log.irritable, 
  symptom = "Irritable")
OR.log.irritable <- exp(coef(log.gad.irritable)) 
OR.CI.log.irritable <- exp(confint(log.gad.irritable))
CI.log.irritable <- add_column(CI.log.irritable, OR = OR.log.irritable)
CI.log.irritable <- add_column(CI.log.irritable, OR.CI.lower = OR.CI.log.irritable[,1])
CI.log.irritable <- add_column(CI.log.irritable, OR.CI.upper = OR.CI.log.irritable[,2])
CI.log.irritable 
CI.log.irritable.age <- CI.log.irritable[2,1:11]
CI.log.irritable.age
CI.log.irritable.sex <- CI.log.irritable[3,1:11]
CI.log.irritable.sex

log.gad.feeling_afraid <- glm(gad.feeling_afraid.cat ~ age_divided + sex + PHQ.total.score + GAD.total.score, data = dat, family = "binomial")
summary(log.gad.feeling_afraid)
CI.log.feeling_afraid <- tidy(log.gad.feeling_afraid, conf.int = TRUE, exponantiate = TRUE)
CI.log.feeling_afraid <- add_column(CI.log.feeling_afraid, 
  symptom = "Feeling afraid")
OR.log.feeling_afraid <- exp(coef(log.gad.feeling_afraid)) 
OR.CI.log.feeling_afraid <- exp(confint(log.gad.feeling_afraid))
CI.log.feeling_afraid <- add_column(CI.log.feeling_afraid, OR = OR.log.feeling_afraid)
CI.log.feeling_afraid <- add_column(CI.log.feeling_afraid, OR.CI.lower = OR.CI.log.feeling_afraid[,1])
CI.log.feeling_afraid <- add_column(CI.log.feeling_afraid, OR.CI.upper = OR.CI.log.feeling_afraid[,2])
CI.log.feeling_afraid 
CI.log.feeling_afraid.age <- CI.log.feeling_afraid[2,1:11]
CI.log.feeling_afraid.age
CI.log.feeling_afraid.sex <- CI.log.feeling_afraid[3,1:11]
CI.log.feeling_afraid.sex

```

Combine the data together
```{r combine data for all gad symptoms}
#bind all the GAD/age rows together
ALL_CI_GAD.age <- bind_rows(CI.log.feeling_anxious.age, 
                            CI.log.control_worrying.age, 
                            CI.log.worry_toomuch.age, 
                            CI.log.trouble_relaxing.age, 
                            CI.log.restless.age, 
                            CI.log.irritable.age, 
                            CI.log.feeling_afraid.age)
#add in column to show the disorder
ALL_CI_GAD.age <- add_column(ALL_CI_GAD.age, disorder = "GAD")
ALL_CI_GAD.age #have a look at the table

#bind all the GAD/sex rows together
ALL_CI_GAD.sex <- bind_rows(CI.log.feeling_anxious.sex, 
                            CI.log.control_worrying.sex, 
                            CI.log.worry_toomuch.sex, 
                            CI.log.trouble_relaxing.sex, 
                            CI.log.restless.sex, 
                            CI.log.irritable.sex, 
                            CI.log.feeling_afraid.sex)
#add in column to show the disorder
ALL_CI_GAD.sex <- add_column(ALL_CI_GAD.sex, disorder = "GAD")
ALL_CI_GAD.sex #have a look at the table
```

Bind all the rows of the tables together for age and sex, and then order according to OR
```{r combine all symptoms and reorder them}
#bind all age rows together
ALL_CI.age <- bind_rows(ALL_CI_GAD.age, ALL_CI_PHQ.age)

ALL_CI.age <- ALL_CI.age %>%
  mutate(p.value.adjusted = 
           p.adjust(p.value, 
                    method = "fdr",
                    n = 16)) #calculated separately at only doing 16 comparisons
#rename term
ALL_CI.age <- ALL_CI.age %>%
  mutate(
    term = 
      "Age/10"
  )

#order
ALL_CI.age.ordered <- 
  arrange(ALL_CI.age, desc(OR))

#bind all sex rows together
ALL_CI.sex <- bind_rows(ALL_CI_GAD.sex, ALL_CI_PHQ.sex)

ALL_CI.sex <- ALL_CI.sex %>%
  mutate(p.value.adjusted = 
           p.adjust(p.value, 
                    method = "fdr",
                    n = 16)) #calculated separately at only doing 16 comparisons
#rename term
ALL_CI.sex <- ALL_CI.sex %>%
  mutate(
    term = 
      "Sex (Female)"
  )
#order
ALL_CI.sex.ordered <- 
  arrange(ALL_CI.sex, desc(OR))

#bind all rows together 
ALL_CI <- bind_rows(ALL_CI.age, ALL_CI.sex)
ALL_CI 

#add significance variable
ALL_CI <- ALL_CI %>%
  mutate(
    Significant.raw = 
      if_else(
        p.value.adjusted < 0.05, 
        1,
        0
      )
  )
#turn into factor
ALL_CI <- ALL_CI %>%
  mutate(Significant = 
  recode_factor(Significant.raw,
    `1` = "Significant",
    `0` = "Non-significant"
      )
  )

#order
ALL_CI.ordered <- arrange(ALL_CI, desc(OR)) #ordered by age variables 

table_for_paper_supp.full <- ALL_CI.ordered[,c(1,8:11,13,15)]
table_for_paper_supp.half <- round(table_for_paper_supp.full[,3:6], 3)
table_for_paper_supp <- cbind(table_for_paper_supp.full[,1:2],table_for_paper_supp.half)
```

Make the symptom into a factor with levels that reflect the PHQ and GAD symptoms
```{r reorder levels of symptoms}
levels <- paste(ALL_CI.sex.ordered$symptom)
#make symptom variable in age data table
ALL_CI.age.ordered$symptom <- factor(ALL_CI.age.ordered$symptom,
                                     levels = paste(ALL_CI.age.ordered$symptom,
                                                    sep = ","))
#make symptom variable in sex data table
ALL_CI.sex.ordered$symptom <- factor(ALL_CI.sex.ordered$symptom,
                                     levels = paste(ALL_CI.sex.ordered$symptom,
                                                    sep = ","))

#make symptom variable in sex data table
ALL_CI.ordered$symptom <- factor(ALL_CI.ordered$symptom,
                                     levels = paste(levels,
                                                    sep = ","))
```

## Age and sex plots {.tabset .tabset-fade}

### Age related variability in symptoms
```{r forest plot for age related variability in symptoms}
#Age variability
age_symptoms_plot <- ggplot(
  ALL_CI.age.ordered,
  aes(x = symptom,
      y = OR,
      ymin = OR.CI.lower,
      ymax = OR.CI.upper)
  ) +
  geom_pointrange(col="black", fill="black", shape=22) +
  labs(y = "OR (95% CI)",
       x = "Symptom",
       title = "Age-related variability in PHQ-9 and GAD-7 symptoms",
       subtitle = paste("n(total) = ", length(dat$PHQ.total.score),
                        "; n(female) = ", sum(!is.na(dat$PHQ.total.score[dat$sex=="Female"])),
                        "; n(male) = ", sum(!is.na(dat$PHQ.total.score[dat$sex=="Male"])), sep = "")) +
  geom_errorbar(aes(ymin=OR.CI.lower, ymax=OR.CI.upper),width=0.2,cex=1)+
  theme(panel.grid.major.x = element_line(size = 0.5,
                                          linetype = 'dashed',
                                          colour = "gray"),
        plot.title=element_text(size=15,face="bold"),
        axis.title.x = element_text(size=12,face="bold"),
        axis.title.y = element_blank(),
        axis.text.x = element_text(colour="black", size = 12),
        axis.text.y = element_text(colour="black", size = 12),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        panel.background = element_blank(),
        legend.position = "bottom") +
  geom_hline(linetype = "dashed", yintercept = 1) +
  scale_y_continuous(trans = log10_trans(), breaks=c(0.8,0.9,1,1.1,1.2, 1.3)) +
  coord_flip()

age_symptoms_plot

#save the plot
ggsave(
  "age_symptoms_plot.pdf",
  plot = age_symptoms_plot,
  device = "pdf",
  path = "../plots/age_and_sex/symptoms/",
  width = 8,
  height = 9
)
#png
ggsave(
  "age_symptoms_plot.png",
  plot = age_symptoms_plot,
  device = "png",
  path = "../plots/age_and_sex/symptoms/",
  width = 8,
  height = 9
)
#jpeg
ggsave(
  "age_factors_plot.jpeg",
  plot = age_symptoms_plot,
  device = "jpeg",
  path = "../plots/age_and_sex/symptoms/",
  width = 8,
  height = 9
)
```

## Sex related variability in symptoms 
```{r forest plot for sex related variability in symptoms}
#Sex variability
sex_symptoms_plot <- ggplot(
  ALL_CI.sex.ordered,
  aes(x = symptom,
      y = OR,
      ymin = OR.CI.lower,
      ymax = OR.CI.upper)
  ) +
  geom_pointrange(col="black", fill="black", shape=22) +
  labs(y = "OR (95% CI)",
       x = "Symptom",
       title = "Sex-related variability in PHQ-9 and GAD-7 symptoms",
       subtitle = paste("n(total) = ", length(dat$PHQ.total.score),
                        "; n(female) = ", sum(!is.na(dat$PHQ.total.score[dat$sex=="Female"])),
                        "; n(male) = ", sum(!is.na(dat$PHQ.total.score[dat$sex=="Male"])), sep = "")) +
  geom_errorbar(aes(ymin=OR.CI.lower, ymax=OR.CI.upper),width=0.2,cex=1)+
  theme(panel.grid.major.x = element_line(size = 0.5,
                                          linetype = 'dashed',
                                          colour = "gray"),
        plot.title=element_text(size=15,face="bold"),
        axis.title.x = element_text(size=12,face="bold"),
        axis.title.y = element_blank(),
        axis.text.x = element_text(colour="black", size = 12),
        axis.text.y = element_text(colour="black", size = 12),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        panel.background = element_blank(),
        legend.position = "bottom") +
   scale_y_continuous(trans = log10_trans(), breaks=c(0.5,0.6, 0.8, 1, 1.2, 1.4, 1.6, 1.8)) +
  geom_hline(linetype = "dashed", yintercept = 1) +
  coord_flip()

sex_symptoms_plot

#save the plot
ggsave(
  "sex_symptoms_plot.pdf",
  plot = sex_symptoms_plot,
  device = "pdf",
  path = "../plots/age_and_sex/symptoms/",
  width = 8,
  height = 9
)
#png
ggsave(
  "sex_symptoms_plot.png",
  plot = sex_symptoms_plot,
  device = "png",
  path = "../plots/age_and_sex/symptoms/",
  width = 8,
  height = 9
)
#jpeg
ggsave(
  "sex_factors_plot.jpeg",
  plot = sex_symptoms_plot,
  device = "jpeg",
  path = "../plots/age_and_sex/symptoms/",
  width = 8,
  height = 9
)
```

## Combined age and sex related variability 
```{r joint ggplot of age and sex variation}
combined_symptoms_plot <- ggplot(
  ALL_CI.ordered,
  aes(x = symptom,
      y = OR,
      ymin = OR.CI.lower,
      ymax = OR.CI.upper,
      colour = term)
  ) +
  scale_fill_manual(values = palette3) +
  scale_color_manual(values = palette3) +
  scale_shape_manual(values = c(19, 21)) +
  geom_pointrange(aes(shape = Significant), position = position_dodge(width = 0.7)) +
  labs(y = "OR (95% CI)",
       x = "Symptom",
       title = "Age and sex-related variability in PHQ-9 and GAD-7 symptoms",
       subtitle = paste("N(Total) = ", length(dat$PHQ.total.score),
                        "; N(Female) = ", sum(!is.na(dat$PHQ.total.score[dat$sex=="Female"])),
                        "; N(Male) = ", sum(!is.na(dat$PHQ.total.score[dat$sex=="Male"])), sep = ""),
       color = "",
       shape = "") +
  theme(panel.grid.major.x = element_line(size = 0.5,
                                          linetype = 'dashed',
                                          colour = "gray"),
        plot.title = element_text(size = 15, face = "bold", hjust=0.5),
        axis.title.x = element_text(size=12,face="bold"),
        axis.title.y = element_blank(),
        axis.text.x = element_text(colour = "black", size = 9),
        axis.text.y = element_text(colour = "black", size = 12),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        panel.background = element_blank(),
        legend.position = "bottom") +
  geom_hline(linetype = "dashed", yintercept = 1) +
  scale_y_continuous(trans = log10_trans(), breaks=c(0.4, 0.6, 0.8, 1, 1.2, 1.4, 1.6, 1.8, 2)) +
  coord_flip()
combined_symptoms_plot

#save the plot
ggsave(
  "combined_symptoms_plot.pdf",
  plot = combined_symptoms_plot,
  device = "pdf",
  path = "../plots/age_and_sex/symptoms/",
  width = 8,
  height = 9
)
#png
ggsave(
  "combined_symptoms_plot.png",
  plot = combined_symptoms_plot,
  device = "png",
  path = "../plots/age_and_sex/symptoms/",
  width = 8,
  height = 9
)
#jpeg
ggsave(
  "combined_symptoms_plot.jpeg",
  plot = combined_symptoms_plot,
  device = "jpeg",
  path = "../plots/age_and_sex/symptoms/",
  width = 8,
  height = 9
)
```

# **Sensitivity analysis with age as categorical** 

## Categorise age into larger groups - collapse older age groups
```{r define age groups}
#create numericage groups
#as we have a lot less people in the older age group - only 60 who are 76 and above - created smaller age groups.  
dat$age.group.numeric.collapse <- case_when(dat$age >= 16 & dat$age <= 23 ~ "1",
                                  dat$age >= 24 & dat$age <= 31 ~ "2",
                                  dat$age >= 32 & dat$age <= 39 ~ "3",
                                  dat$age >= 40 & dat$age <= 47 ~ "4",
                                  dat$age >= 48 & dat$age <= 55 ~ "5",
                                  dat$age >= 56 & dat$age <= 63 ~ "6",
                                  dat$age >= 64 & dat$age <= 95 ~ "7")

#createage groups asfactors 
dat$age.group.factor.collapse <- recode_factor(dat$age.group.numeric.collapse,
                                         "1" = "16 to 23 years",
                                         "2" = "24 to 31 years",
                                         "3" = "32 to 39 years",
                                         "4" = "40 to 47 years",
                                         "5" = "48 to 55 years",
                                         "6" = "56 to 63 years",
                                         "7" = "64 to 95 years")

#create data sets for each age group
data.age1 <- dat %>% filter(age.group.numeric.collapse == 1)
data.age2 <- dat %>% filter(age.group.numeric.collapse == 2)
data.age3 <- dat %>% filter(age.group.numeric.collapse == 3)
data.age4 <- dat %>% filter(age.group.numeric.collapse == 4)
data.age5 <- dat %>% filter(age.group.numeric.collapse == 5)
data.age6 <- dat %>% filter(age.group.numeric.collapse == 6)
data.age7 <- dat %>% filter(age.group.numeric.collapse == 7)

table(dat$age.group.factor.collapse)
```

## Reorder age factor for largest group as comparison group 
```{r relevel age factor to use middle as comparison}
age.group.factor.collapse.reordered <- relevel(dat$age.group.factor.collapse, "40 to 47 years", first = TRUE, collapse = "+", xlevels= TRUE)
```

```{r labels for age groups }
age.group.collapse.reordered.label <- c("Intercept",
                               "16 to 23 years",
                               "24 to 31 years",
                               "32 to 39 years",
                               "48 to 55 years",
                               "56 to 63 years",
                               "64 years and above",
                               "Sex", 
                               "PHQ",
                               "GAD")
```

## Logistic regression with age as categorical for PHQ
```{r logistic regression with age as categorical}
#Anhedonia
log.phq.anhedonia.cat <- glm(phq.anhedonia.cat ~ age.group.factor.collapse.reordered  + sex + PHQ.total.score + GAD.total.score, data = dat, family = "binomial")
summary(log.phq.anhedonia.cat)
CI.log.anhedonia.cat <- tidy(log.phq.anhedonia.cat, conf.int = TRUE, exponantiate = TRUE)
CI.log.anhedonia.cat <- add_column(CI.log.anhedonia.cat, symptom = "Anhedonia")
OR.log.anhedonia.cat <- exp(coef(log.phq.anhedonia.cat)) 
OR.CI.log.anhedonia.cat <- exp(confint(log.phq.anhedonia.cat))
CI.log.anhedonia.cat <- add_column(CI.log.anhedonia.cat, OR = OR.log.anhedonia.cat)
CI.log.anhedonia.cat <- add_column(CI.log.anhedonia.cat, OR.CI.lower = OR.CI.log.anhedonia.cat[,1])
CI.log.anhedonia.cat <- add_column(CI.log.anhedonia.cat, OR.CI.upper = OR.CI.log.anhedonia.cat[,2])
CI.log.anhedonia.cat <- add_column(CI.log.anhedonia.cat, Key = age.group.collapse.reordered.label)
CI.log.anhedonia.age.cat <- CI.log.anhedonia.cat[2:7,1:12]
CI.log.anhedonia.age.cat

#depressed_mood
log.phq.depressed_mood.cat <- glm(phq.depressed_mood.cat ~ age.group.factor.collapse.reordered  + sex + PHQ.total.score + GAD.total.score, data = dat, family = "binomial")
summary(log.phq.depressed_mood.cat)
CI.log.depressed_mood.cat <- tidy(log.phq.depressed_mood.cat, conf.int = TRUE, exponantiate = TRUE)
CI.log.depressed_mood.cat <- add_column(CI.log.depressed_mood.cat, symptom = "Depressed mood")
OR.log.depressed_mood.cat <- exp(coef(log.phq.depressed_mood.cat)) 
OR.CI.log.depressed_mood.cat <- exp(confint(log.phq.depressed_mood.cat))
CI.log.depressed_mood.cat <- add_column(CI.log.depressed_mood.cat, OR = OR.log.depressed_mood.cat)
CI.log.depressed_mood.cat <- add_column(CI.log.depressed_mood.cat, OR.CI.lower = OR.CI.log.depressed_mood.cat[,1])
CI.log.depressed_mood.cat <- add_column(CI.log.depressed_mood.cat, OR.CI.upper = OR.CI.log.depressed_mood.cat[,2])
CI.log.depressed_mood.cat <- add_column(CI.log.depressed_mood.cat, Key = age.group.collapse.reordered.label)
CI.log.depressed_mood.age.cat <- CI.log.depressed_mood.cat[2:7,1:12]
CI.log.depressed_mood.age.cat

#sleep_change
log.phq.sleep_change.cat <- glm(phq.sleep_change.cat ~ age.group.factor.collapse.reordered  + sex + PHQ.total.score + GAD.total.score, data = dat, family = "binomial")
summary(log.phq.sleep_change.cat)
CI.log.sleep_change.cat <- tidy(log.phq.sleep_change.cat, conf.int = TRUE, exponantiate = TRUE)
CI.log.sleep_change.cat <- add_column(CI.log.sleep_change.cat, symptom = "Sleep change")
OR.log.sleep_change.cat <- exp(coef(log.phq.sleep_change.cat)) 
OR.CI.log.sleep_change.cat <- exp(confint(log.phq.sleep_change.cat))
CI.log.sleep_change.cat <- add_column(CI.log.sleep_change.cat, OR = OR.log.sleep_change.cat)
CI.log.sleep_change.cat <- add_column(CI.log.sleep_change.cat, OR.CI.lower = OR.CI.log.sleep_change.cat[,1])
CI.log.sleep_change.cat <- add_column(CI.log.sleep_change.cat, OR.CI.upper = OR.CI.log.sleep_change.cat[,2])
CI.log.sleep_change.cat <- add_column(CI.log.sleep_change.cat, Key = age.group.collapse.reordered.label)
CI.log.sleep_change.age.cat <- CI.log.sleep_change.cat[2:7,1:12]
CI.log.sleep_change.age.cat

#little_energy
log.phq.little_energy.cat <- glm(phq.little_energy.cat ~ age.group.factor.collapse.reordered  + sex + PHQ.total.score + GAD.total.score, data = dat, family = "binomial")
summary(log.phq.little_energy.cat)
CI.log.little_energy.cat <- tidy(log.phq.little_energy.cat, conf.int = TRUE, exponantiate = TRUE)
CI.log.little_energy.cat <- add_column(CI.log.little_energy.cat, symptom = "Little energy")
OR.log.little_energy.cat <- exp(coef(log.phq.little_energy.cat)) 
OR.CI.log.little_energy.cat <- exp(confint(log.phq.little_energy.cat))
CI.log.little_energy.cat <- add_column(CI.log.little_energy.cat, OR = OR.log.little_energy.cat)
CI.log.little_energy.cat <- add_column(CI.log.little_energy.cat, OR.CI.lower = OR.CI.log.little_energy.cat[,1])
CI.log.little_energy.cat <- add_column(CI.log.little_energy.cat, OR.CI.upper = OR.CI.log.little_energy.cat[,2])
CI.log.little_energy.cat <- add_column(CI.log.little_energy.cat, Key = age.group.collapse.reordered.label)
CI.log.little_energy.age.cat <- CI.log.little_energy.cat[2:7,1:12]
CI.log.little_energy.age.cat

#eating_problems
log.phq.eating_problems.cat <- glm(phq.eating_problems.cat ~ age.group.factor.collapse.reordered  + sex + PHQ.total.score + GAD.total.score, data = dat, family = "binomial")
summary(log.phq.eating_problems.cat)
CI.log.eating_problems.cat <- tidy(log.phq.eating_problems.cat, conf.int = TRUE, exponantiate = TRUE)
CI.log.eating_problems.cat <- add_column(CI.log.eating_problems.cat, symptom = "Weight or appetite problems")
OR.log.eating_problems.cat <- exp(coef(log.phq.eating_problems.cat)) 
OR.CI.log.eating_problems.cat <- exp(confint(log.phq.eating_problems.cat))
CI.log.eating_problems.cat <- add_column(CI.log.eating_problems.cat, OR = OR.log.eating_problems.cat)
CI.log.eating_problems.cat <- add_column(CI.log.eating_problems.cat, OR.CI.lower = OR.CI.log.eating_problems.cat[,1])
CI.log.eating_problems.cat <- add_column(CI.log.eating_problems.cat, OR.CI.upper = OR.CI.log.eating_problems.cat[,2])
CI.log.eating_problems.cat <- add_column(CI.log.eating_problems.cat, Key = age.group.collapse.reordered.label)
CI.log.eating_problems.age.cat <- CI.log.eating_problems.cat[2:7,1:12]
CI.log.eating_problems.age.cat

#worthlessness
log.phq.worthlessness.cat <- glm(phq.worthlessness.cat ~ age.group.factor.collapse.reordered  + sex + PHQ.total.score + GAD.total.score, data = dat, family = "binomial")
summary(log.phq.worthlessness.cat)
CI.log.worthlessness.cat <- tidy(log.phq.worthlessness.cat, conf.int = TRUE, exponantiate = TRUE)
CI.log.worthlessness.cat <- add_column(CI.log.worthlessness.cat, symptom = "Worthlessness")
OR.log.worthlessness.cat <- exp(coef(log.phq.worthlessness.cat)) 
OR.CI.log.worthlessness.cat <- exp(confint(log.phq.worthlessness.cat))
CI.log.worthlessness.cat <- add_column(CI.log.worthlessness.cat, OR = OR.log.worthlessness.cat)
CI.log.worthlessness.cat <- add_column(CI.log.worthlessness.cat, OR.CI.lower = OR.CI.log.worthlessness.cat[,1])
CI.log.worthlessness.cat <- add_column(CI.log.worthlessness.cat, OR.CI.upper = OR.CI.log.worthlessness.cat[,2])
CI.log.worthlessness.cat <- add_column(CI.log.worthlessness.cat, Key = age.group.collapse.reordered.label)
CI.log.worthlessness.age.cat <- CI.log.worthlessness.cat[2:7,1:12]
CI.log.worthlessness.age.cat

#concentration_problems
log.phq.concentration_problems.cat <- glm(phq.concentration_problems.cat ~ age.group.factor.collapse.reordered  + sex + PHQ.total.score + GAD.total.score, data = dat, family = "binomial")
summary(log.phq.concentration_problems.cat)
CI.log.concentration_problems.cat <- tidy(log.phq.concentration_problems.cat, conf.int = TRUE, exponantiate = TRUE)
CI.log.concentration_problems.cat <- add_column(CI.log.concentration_problems.cat, symptom = "Concentration problems")
OR.log.concentration_problems.cat <- exp(coef(log.phq.concentration_problems.cat)) 
OR.CI.log.concentration_problems.cat <- exp(confint(log.phq.concentration_problems.cat))
CI.log.concentration_problems.cat <- add_column(CI.log.concentration_problems.cat, OR = OR.log.concentration_problems.cat)
CI.log.concentration_problems.cat <- add_column(CI.log.concentration_problems.cat, OR.CI.lower = OR.CI.log.concentration_problems.cat[,1])
CI.log.concentration_problems.cat <- add_column(CI.log.concentration_problems.cat, OR.CI.upper = OR.CI.log.concentration_problems.cat[,2])
CI.log.concentration_problems.cat <- add_column(CI.log.concentration_problems.cat, Key = age.group.collapse.reordered.label)
CI.log.concentration_problems.age.cat <- CI.log.concentration_problems.cat[2:7,1:12]
CI.log.concentration_problems.age.cat

#motor_problems
log.phq.motor_problems.cat <- glm(phq.motor_problems.cat ~ age.group.factor.collapse.reordered  + sex + PHQ.total.score + GAD.total.score, data = dat, family = "binomial")
summary(log.phq.motor_problems.cat)
CI.log.motor_problems.cat <- tidy(log.phq.motor_problems.cat, conf.int = TRUE, exponantiate = TRUE)
CI.log.motor_problems.cat <- add_column(CI.log.motor_problems.cat, symptom = "Motor problems")
OR.log.motor_problems.cat <- exp(coef(log.phq.motor_problems.cat)) 
OR.CI.log.motor_problems.cat <- exp(confint(log.phq.motor_problems.cat))
CI.log.motor_problems.cat <- add_column(CI.log.motor_problems.cat, OR = OR.log.motor_problems.cat)
CI.log.motor_problems.cat <- add_column(CI.log.motor_problems.cat, OR.CI.lower = OR.CI.log.motor_problems.cat[,1])
CI.log.motor_problems.cat <- add_column(CI.log.motor_problems.cat, OR.CI.upper = OR.CI.log.motor_problems.cat[,2])
CI.log.motor_problems.cat <- add_column(CI.log.motor_problems.cat, Key = age.group.collapse.reordered.label)
CI.log.motor_problems.age.cat <- CI.log.motor_problems.cat[2:7,1:12]
CI.log.motor_problems.age.cat

#suicide_ideation
log.phq.suicide_ideation.cat <- glm(phq.suicide_ideation.cat ~ age.group.factor.collapse.reordered  + sex + PHQ.total.score + GAD.total.score, data = dat, family = "binomial")
summary(log.phq.suicide_ideation.cat)
CI.log.suicide_ideation.cat <- tidy(log.phq.suicide_ideation.cat, conf.int = TRUE, exponantiate = TRUE)
CI.log.suicide_ideation.cat <- add_column(CI.log.suicide_ideation.cat, symptom = "Suicide ideation")
OR.log.suicide_ideation.cat <- exp(coef(log.phq.suicide_ideation.cat)) 
OR.CI.log.suicide_ideation.cat <- exp(confint(log.phq.suicide_ideation.cat))
CI.log.suicide_ideation.cat <- add_column(CI.log.suicide_ideation.cat, OR = OR.log.suicide_ideation.cat)
CI.log.suicide_ideation.cat <- add_column(CI.log.suicide_ideation.cat, OR.CI.lower = OR.CI.log.suicide_ideation.cat[,1])
CI.log.suicide_ideation.cat <- add_column(CI.log.suicide_ideation.cat, OR.CI.upper = OR.CI.log.suicide_ideation.cat[,2])
CI.log.suicide_ideation.cat <- add_column(CI.log.suicide_ideation.cat, Key = age.group.collapse.reordered.label)
CI.log.suicide_ideation.age.cat <- CI.log.suicide_ideation.cat[2:7,1:12]
CI.log.suicide_ideation.age.cat

```

## Logistic regression with age as categorical for GAD
```{r logistic regression with ageas categorical}
#feeling_anxious
log.gad.feeling_anxious.cat <- glm(gad.feeling_anxious.cat ~ age.group.factor.collapse.reordered + sex + PHQ.total.score + GAD.total.score, data = dat, family = "binomial")
summary(log.gad.feeling_anxious.cat)
CI.log.feeling_anxious.cat <- tidy(log.gad.feeling_anxious.cat, conf.int = TRUE, exponantiate = TRUE)
CI.log.feeling_anxious.cat <- add_column(CI.log.feeling_anxious.cat, symptom = "Feeling anxious")
OR.log.feeling_anxious.cat <- exp(coef(log.gad.feeling_anxious.cat)) 
OR.CI.log.feeling_anxious.cat <- exp(confint(log.gad.feeling_anxious.cat))
CI.log.feeling_anxious.cat <- add_column(CI.log.feeling_anxious.cat, OR = OR.log.feeling_anxious.cat)
CI.log.feeling_anxious.cat <- add_column(CI.log.feeling_anxious.cat, OR.CI.lower = OR.CI.log.feeling_anxious.cat[,1])
CI.log.feeling_anxious.cat <- add_column(CI.log.feeling_anxious.cat, OR.CI.upper = OR.CI.log.feeling_anxious.cat[,2])
CI.log.feeling_anxious.cat <- add_column(CI.log.feeling_anxious.cat, Key = age.group.collapse.reordered.label)
CI.log.feeling_anxious.cat <- CI.log.feeling_anxious.cat[2:7,1:12]
CI.log.feeling_anxious.cat

#control_worrying
log.gad.control_worrying.cat <- glm(gad.control_worrying.cat ~ age.group.factor.collapse.reordered + sex + PHQ.total.score + GAD.total.score, data = dat, family = "binomial")
summary(log.gad.control_worrying.cat)
CI.log.control_worrying.cat <- tidy(log.gad.control_worrying.cat, conf.int = TRUE, exponantiate = TRUE)
CI.log.control_worrying.cat <- add_column(CI.log.control_worrying.cat, symptom = "Difficulty controlling worrying")
OR.log.control_worrying.cat <- exp(coef(log.gad.control_worrying.cat)) 
OR.CI.log.control_worrying.cat <- exp(confint(log.gad.control_worrying.cat))
CI.log.control_worrying.cat <- add_column(CI.log.control_worrying.cat, OR = OR.log.control_worrying.cat)
CI.log.control_worrying.cat <- add_column(CI.log.control_worrying.cat, OR.CI.lower = OR.CI.log.control_worrying.cat[,1])
CI.log.control_worrying.cat <- add_column(CI.log.control_worrying.cat, OR.CI.upper = OR.CI.log.control_worrying.cat[,2])
CI.log.control_worrying.cat <- add_column(CI.log.control_worrying.cat, Key = age.group.collapse.reordered.label)
CI.log.control_worrying.cat <- CI.log.control_worrying.cat[2:7,1:12]
CI.log.control_worrying.cat

#worry_toomuch
log.gad.worry_toomuch.cat <- glm(gad.worry_toomuch.cat ~ age.group.factor.collapse.reordered + sex + PHQ.total.score + GAD.total.score, data = dat, family = "binomial")
summary(log.gad.worry_toomuch.cat)
CI.log.worry_toomuch.cat <- tidy(log.gad.worry_toomuch.cat, conf.int = TRUE, exponantiate = TRUE)
CI.log.worry_toomuch.cat <- add_column(CI.log.worry_toomuch.cat, symptom = "Worrying too much")
OR.log.worry_toomuch.cat <- exp(coef(log.gad.worry_toomuch.cat)) 
OR.CI.log.worry_toomuch.cat <- exp(confint(log.gad.worry_toomuch.cat))
CI.log.worry_toomuch.cat <- add_column(CI.log.worry_toomuch.cat, OR = OR.log.worry_toomuch.cat)
CI.log.worry_toomuch.cat <- add_column(CI.log.worry_toomuch.cat, OR.CI.lower = OR.CI.log.worry_toomuch.cat[,1])
CI.log.worry_toomuch.cat <- add_column(CI.log.worry_toomuch.cat, OR.CI.upper = OR.CI.log.worry_toomuch.cat[,2])
CI.log.worry_toomuch.cat <- add_column(CI.log.worry_toomuch.cat, Key = age.group.collapse.reordered.label)
CI.log.worry_toomuch.cat <- CI.log.worry_toomuch.cat[2:7,1:12]
CI.log.worry_toomuch.cat

#trouble_relaxing
log.gad.trouble_relaxing.cat <- glm(gad.trouble_relaxing.cat ~ age.group.factor.collapse.reordered + sex + PHQ.total.score + GAD.total.score, data = dat, family = "binomial")
summary(log.gad.trouble_relaxing.cat)
CI.log.trouble_relaxing.cat <- tidy(log.gad.trouble_relaxing.cat, conf.int = TRUE, exponantiate = TRUE)
CI.log.trouble_relaxing.cat <- add_column(CI.log.trouble_relaxing.cat, symptom = "Trouble relaxing")
OR.log.trouble_relaxing.cat <- exp(coef(log.gad.trouble_relaxing.cat)) 
OR.CI.log.trouble_relaxing.cat <- exp(confint(log.gad.trouble_relaxing.cat))
CI.log.trouble_relaxing.cat <- add_column(CI.log.trouble_relaxing.cat, OR = OR.log.trouble_relaxing.cat)
CI.log.trouble_relaxing.cat <- add_column(CI.log.trouble_relaxing.cat, OR.CI.lower = OR.CI.log.trouble_relaxing.cat[,1])
CI.log.trouble_relaxing.cat <- add_column(CI.log.trouble_relaxing.cat, OR.CI.upper = OR.CI.log.trouble_relaxing.cat[,2])
CI.log.trouble_relaxing.cat <- add_column(CI.log.trouble_relaxing.cat, Key = age.group.collapse.reordered.label)
CI.log.trouble_relaxing.cat <- CI.log.trouble_relaxing.cat[2:7,1:12]
CI.log.trouble_relaxing.cat

#restless
log.gad.restless.cat <- glm(gad.restless.cat ~ age.group.factor.collapse.reordered + sex + PHQ.total.score + GAD.total.score, data = dat, family = "binomial")
summary(log.gad.restless.cat)
CI.log.restless.cat <- tidy(log.gad.restless.cat, conf.int = TRUE, exponantiate = TRUE)
CI.log.restless.cat <- add_column(CI.log.restless.cat, symptom = "Restlessness")
OR.log.restless.cat <- exp(coef(log.gad.restless.cat)) 
OR.CI.log.restless.cat <- exp(confint(log.gad.restless.cat))
CI.log.restless.cat <- add_column(CI.log.restless.cat, OR = OR.log.restless.cat)
CI.log.restless.cat <- add_column(CI.log.restless.cat, OR.CI.lower = OR.CI.log.restless.cat[,1])
CI.log.restless.cat <- add_column(CI.log.restless.cat, OR.CI.upper = OR.CI.log.restless.cat[,2])
CI.log.restless.cat <- add_column(CI.log.restless.cat, Key = age.group.collapse.reordered.label)
CI.log.restless.cat <- CI.log.restless.cat[2:7,1:12]
CI.log.restless.cat

#irritable
log.gad.irritable.cat <- glm(gad.irritable.cat ~ age.group.factor.collapse.reordered + sex + PHQ.total.score + GAD.total.score, data = dat, family = "binomial")
summary(log.gad.irritable.cat)
CI.log.irritable.cat <- tidy(log.gad.irritable.cat, conf.int = TRUE, exponantiate = TRUE)
CI.log.irritable.cat <- add_column(CI.log.irritable.cat, symptom = "Irritable")
OR.log.irritable.cat <- exp(coef(log.gad.irritable.cat)) 
OR.CI.log.irritable.cat <- exp(confint(log.gad.irritable.cat))
CI.log.irritable.cat <- add_column(CI.log.irritable.cat, OR = OR.log.irritable.cat)
CI.log.irritable.cat <- add_column(CI.log.irritable.cat, OR.CI.lower = OR.CI.log.irritable.cat[,1])
CI.log.irritable.cat <- add_column(CI.log.irritable.cat, OR.CI.upper = OR.CI.log.irritable.cat[,2])
CI.log.irritable.cat <- add_column(CI.log.irritable.cat, Key = age.group.collapse.reordered.label)
CI.log.irritable.cat <- CI.log.irritable.cat[2:7,1:12]
CI.log.irritable.cat

#feeling_afraid
log.gad.feeling_afraid.cat <- glm(gad.feeling_afraid.cat ~ age.group.factor.collapse.reordered + sex + PHQ.total.score + GAD.total.score, data = dat, family = "binomial")
summary(log.gad.feeling_afraid.cat)
CI.log.feeling_afraid.cat <- tidy(log.gad.feeling_afraid.cat, conf.int = TRUE, exponantiate = TRUE)
CI.log.feeling_afraid.cat <- add_column(CI.log.feeling_afraid.cat, symptom = "Feeling afraid")
OR.log.feeling_afraid.cat <- exp(coef(log.gad.feeling_afraid.cat)) 
OR.CI.log.feeling_afraid.cat <- exp(confint(log.gad.feeling_afraid.cat))
CI.log.feeling_afraid.cat <- add_column(CI.log.feeling_afraid.cat, OR = OR.log.feeling_afraid.cat)
CI.log.feeling_afraid.cat <- add_column(CI.log.feeling_afraid.cat, OR.CI.lower = OR.CI.log.feeling_afraid.cat[,1])
CI.log.feeling_afraid.cat <- add_column(CI.log.feeling_afraid.cat, OR.CI.upper = OR.CI.log.feeling_afraid.cat[,2])
CI.log.feeling_afraid.cat <- add_column(CI.log.feeling_afraid.cat, Key = age.group.collapse.reordered.label)
CI.log.feeling_afraid.cat <- CI.log.feeling_afraid.cat[2:7,1:12]
CI.log.feeling_afraid.cat

```

```{r combine categorical datasets}
ALL_CI.phq.age.cat <- bind_rows(CI.log.anhedonia.age.cat, CI.log.depressed_mood.age.cat, CI.log.sleep_change.age.cat, CI.log.little_energy.age.cat, CI.log.eating_problems.age.cat, CI.log.worthlessness.age.cat, CI.log.concentration_problems.age.cat, CI.log.motor_problems.age.cat, CI.log.suicide_ideation.age.cat)
ALL_CI.phq.age.cat

ALL_CI.gad.age.cat <- bind_rows(CI.log.feeling_anxious.cat, CI.log.control_worrying.cat, CI.log.worry_toomuch.cat, CI.log.trouble_relaxing.cat, CI.log.restless.cat, CI.log.irritable.cat, CI.log.feeling_afraid.cat)
ALL_CI.gad.age.cat

ALL_CI.age.cat <- bind_rows(ALL_CI.phq.age.cat, ALL_CI.gad.age.cat)
ALL_CI.age.cat
```

```{r combine all categorical symptoms and reorder them}
#add in significance level
ALL_CI.age.cat <- ALL_CI.age.cat %>%
  mutate(
    p.value.adjusted = 
           p.adjust(p.value, 
                    method = "fdr",
                    n = 96)) #calculated separately 6 group comparisons * 16 symptoms = 96 comparisons

#add significance variable
ALL_CI.age.cat <- ALL_CI.age.cat %>%
  mutate(
    Significant.raw = 
      if_else(
        p.value.adjusted < 0.05, 
        1,
        0
      )
  )

#turn into factor
ALL_CI.age.cat  <- ALL_CI.age.cat  %>%
  mutate(Significant = 
  recode_factor(Significant.raw,
    `1` = "Significant",
    `0` = "Non-significant"
      )
  )

#order according to OR
ALL_CI.age.ordered.cat <- 
  arrange(ALL_CI.age.cat, desc(OR))
ALL_CI.age.ordered.cat
```


## Forest plot for categorical age 

```{r plot for OR for categorical age and MDD and GAD symptoms }
age.cat.plot <- ggplot(
  data = ALL_CI.age.cat,
    aes(
      x = Key,
      y = OR, 
      ymin = OR.CI.lower, 
      ymax = OR.CI.upper )) +
    geom_pointrange(aes(x = reorder(Key, desc(Key)), shape = Significant, col = Key)) +
    geom_hline(aes(fill=Key), yintercept =1, linetype=2) +
  labs(y = "OR (95% CI)",
       x = "",
       title = "Categorical age-related variation in GAD-7 and PHQ-9") +
    theme(plot.title=element_text(size = 16,face = "bold", hjust = 0.5),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(face = "bold"),
        axis.title = element_text(size =12, face="bold"),
        strip.text.y = element_text(hjust = 0,vjust = 1, angle = 90,face = "bold")) +
    facet_wrap(~symptom, strip.position = "top", nrow = 4, scales = "free_y") +
    coord_flip()

age.cat.plot


#save the plot
ggsave(
  "age.cat.plot.pdf",
  plot = age.cat.plot,
  device = "pdf",
  path = "../plots/age_and_sex/symptoms/",
  width = 9,
  height = 7
)
#png
ggsave(
  "age.cat.plot.png",
  plot = age.cat.plot,
  device = "png",
  path = "../plots/age_and_sex/symptoms/",
  width = 9,
  height = 7
)
#jpeg
ggsave(
  "age.cat.plot.jpeg",
  plot = age.cat.plot,
  device = "jpeg",
  path = "../plots/age_and_sex/symptoms/",
  width = 9,
  height = 7
)
```

# **Age and sex related variability for the identified factors**

## Distribution of factor scores

```{r histograms for factor scores}
hist(dat$worry)
hist(dat$mood)
hist(dat$somatic)
hist(dat$motor)
```

## Create correlation matrix of each sum score and factor score 

```{r create data frame for factors correlation matrix}
factor.sum.score.items <- c("PHQ.total.score",
                           "GAD.total.score",
                           "worry",
                           "mood",
                           "somatic",
                           "motor")

factor.sum.score.df <- as.data.frame(dat [,factor.sum.score.items])  #create your dataframe with the sum scores and factor scores 

is.data.frame(factor.sum.score.df)  #check that it is a dataframe 

colnames(factor.sum.score.df) <- c("PHQ sum score",   #Add in the names you would like for your variables
                                 "GAD sum score", 
                                 "Worry factor score", 
                                 "Mood factor score", 
                                 "Somatic factor score",
                                 "Motor factor score")
```

```{r correlation matrix for factor scores and sum scores}
factor.sum.score.matrix <- cor(factor.sum.score.df, 
                               method = "pearson", 
                               use = "complete.obs")
factor.sum.score.matrix 
```

```{r heat map for factor and sum scores}
# Reorder the correlation matrix
cor_matrix_factorsum <- reorder_cor_matrix(factor.sum.score.matrix)
  
#melt the values
metled_cor_matrix_factorsum <- melt(cor_matrix_factorsum, na.rm = TRUE)
metled_cor_matrix_factorsum

#correlation heat map
factorsum_correlation_heat_map <- ggplot(metled_cor_matrix_factorsum, aes(Var2, Var1, fill = value))+
 geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white",
   midpoint = 0, limit = c(-1,1), space = "Lab",
    name="Pearson\nCorrelation") +
  theme_minimal() +
  labs(y = "Items",
       x = "Items",
       title = "Correlation heat map for factor scores and sum scores"
       )+
 theme(axis.text.x = element_text(angle = 45, vjust = 1,
    size = 12, hjust = 1))+
 coord_fixed() +
  geom_text(aes(Var2, Var1, label = round(value, digits = 2)), color = "black", size = 3)
factorsum_correlation_heat_map
```

## Linear regressions for factors - age_divided + sex + PHQ.total.score + GAD.total.score

R-squared is a goodness-of-fit measure for linear regression models. 
This statistic indicates the percentage of the variance in the dependent variable that the independent variables explain collectively. 
```{r linear regression models for factor scores}
#Worry factor scores
lin.worry_factor <- lm(worry ~ age_divided + sex + PHQ.total.score + GAD.total.score,
              data = dat)
summary(lin.worry_factor ) #standard summary of model
CI.lin.worry_factor <- tidy(lin.worry_factor, conf.int = TRUE, exponentiate = TRUE) #tidy summary with confidence intervals
CI.lin.worry_factor <- add_column(CI.lin.worry_factor, #add column to indicate the factor
  factor = "Worry symptoms")
CI.lin.worry_factor #previouslt used OR.log.motor_factor <- exp(coef(log.motor_factor.endorsement)) to get OR
CI.lin.worry_factor.age <- CI.lin.worry_factor[2,1:8]  
CI.lin.worry_factor.age
CI.lin.worry_factor.sex <- CI.lin.worry_factor[3,1:8] 
CI.lin.worry_factor.sex

#Mood factor scores
lin.mood_factor <- lm(mood ~ age_divided + sex + PHQ.total.score + GAD.total.score,
              data = dat)
summary(lin.mood_factor ) #standard summary of model
CI.lin.mood_factor <- tidy(lin.mood_factor, conf.int = TRUE, exponentiate = TRUE) #tidy summary with confidence intervals
CI.lin.mood_factor <- add_column(CI.lin.mood_factor, #add column to indicate the factor
  factor = "Mood symptoms")
CI.lin.mood_factor 
CI.lin.mood_factor.age <- CI.lin.mood_factor[2,1:8]  
CI.lin.mood_factor.age
CI.lin.mood_factor.sex <- CI.lin.mood_factor[3,1:8]  
CI.lin.mood_factor.sex

#Somatic factor scores
lin.somatic_factor <- lm(somatic ~ age_divided + sex + PHQ.total.score + GAD.total.score,
              data = dat)
summary(lin.somatic_factor ) #standard summary of model
CI.lin.somatic_factor <- tidy(lin.somatic_factor, conf.int = TRUE, exponentiate = TRUE) #tidy summary with confidence intervals
CI.lin.somatic_factor <- add_column(CI.lin.somatic_factor, #add column to indicate the factor
  factor = "Somatic symptoms")
CI.lin.somatic_factor 
CI.lin.somatic_factor.age <- CI.lin.somatic_factor[2,1:8]  
CI.lin.somatic_factor.age
CI.lin.somatic_factor.sex <- CI.lin.somatic_factor[3,1:8]  
CI.lin.somatic_factor.sex

#Motor factor scores
lin.motor_factor <- lm(motor ~ age_divided + sex + PHQ.total.score + GAD.total.score,
              data = dat)
summary(lin.motor_factor ) #standard summary of model
CI.lin.motor_factor <- tidy(lin.motor_factor, conf.int = TRUE, exponentiate = TRUE) #tidy summary with confidence intervals
CI.lin.motor_factor <- add_column(CI.lin.motor_factor, #add column to indicate the factor
  factor = "Motor symptoms")
CI.lin.motor_factor 
CI.lin.motor_factor.age <- CI.lin.motor_factor[2,1:8]  
CI.lin.motor_factor.age
CI.lin.motor_factor.sex <- CI.lin.motor_factor[3,1:8]  
CI.lin.motor_factor.sex
```

Combine rows of CIs
```{r combine datasets }
#bind all age rows together
ALL_CI_factor.age <- bind_rows(CI.lin.mood_factor.age, 
                               CI.lin.worry_factor.age, 
                               CI.lin.somatic_factor.age, 
                               CI.lin.motor_factor.age)
#pvalue correction
ALL_CI_factor.age <- ALL_CI_factor.age %>%
  mutate(p.value.adjusted = 
           p.adjust(p.value, 
                    method = "fdr",
                    n = 8)) #calculated separately at only doing 8comparisons
#rename term
ALL_CI_factor.age  <- ALL_CI_factor.age %>%
  mutate(
    term = 
      "Age/10"
  )

#order
ALL_CI_factor.age.ordered <- 
  arrange(ALL_CI_factor.age, desc(estimate))


#bind all sex rows together
ALL_CI_factor.sex <- bind_rows(CI.lin.mood_factor.sex, 
                               CI.lin.worry_factor.sex, 
                               CI.lin.somatic_factor.sex, 
                               CI.lin.motor_factor.sex)
#adjust pvalue
ALL_CI_factor.sex <- ALL_CI_factor.sex %>%
  mutate(p.value.adjusted = 
           p.adjust(p.value, 
                    method = "fdr",
                    n = 16)) #calculated separately at only doing 16 comparisons
#rename term
ALL_CI_factor.sex <- ALL_CI_factor.sex %>%
  mutate(
    term = 
      "Sex (Female)"
  )
#order
ALL_CI_factor.sex.ordered <- 
  arrange(ALL_CI_factor.sex, desc(estimate))

#bind all rows together 
ALL_CI_factor <- bind_rows(ALL_CI_factor.age, ALL_CI_factor.sex)
ALL_CI_factor 

#add significance variable
ALL_CI_factor <- ALL_CI_factor %>%
  mutate(
    Significant.raw = 
      if_else(
        p.value.adjusted < 0.05, 
        1,
        0
      )
  )
#turn into factor
ALL_CI_factor <- ALL_CI_factor %>%
  mutate(Significant = 
  recode_factor(Significant.raw,
    `1` = "Significant",
    `0` = "Non-significant"
      )
  )

#order
ALL_CI_factor.ordered <- arrange(ALL_CI_factor, desc(estimate)) #ordered by age variables 

```

Make the symptom factor variable into a factor
```{r make the factor variable into a factor}
levels_factor <- ALL_CI_factor.sex.ordered$factor

ALL_CI_factor.age.ordered$factor <- factor(ALL_CI_factor.age.ordered$factor, 
                                           levels = paste(ALL_CI_factor.age.ordered$factor, 
                                                          sep = ","))

ALL_CI_factor.sex.ordered$factor <- factor(ALL_CI_factor.sex.ordered$factor, 
                                           levels = paste(ALL_CI_factor.sex.ordered$factor, 
                                                          sep = ","))

ALL_CI_factor.ordered$factor <- factor(ALL_CI_factor.ordered$factor, 
                                           levels = paste(levels_factor, 
                                                          sep = ","))

```

## Factor plots  {.tabset .tabset-fade}

### Age 
```{r forest plot for age related variability in factors}
#Age related variability
age_factors_plot <- ggplot(
  ALL_CI_factor.age.ordered,
  aes(x = factor,
      y = estimate,
      ymin = conf.low,
      ymax = conf.high)
  ) +
  geom_pointrange(col="black", fill="black", shape=22) +
  labs(y = "Standardised Estimate (95% CI)",
       x = "Symptom",
       title = "Age-related variability in anxiety and depression factors",
       subtitle = paste("n(total) = ", length(dat$PHQ.total.score),
                        "; n(female) = ", sum(!is.na(dat$PHQ.total.score[dat$sex=="Female"])),
                        "; n(male) = ", sum(!is.na(dat$PHQ.total.score[dat$sex=="Male"])),"\n",
                        sep = "")) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high),width=0.2,cex=1)+
  theme(panel.grid.major.x = element_line(size = 0.5,
                                          linetype = 'dashed',
                                          colour = "gray"),
        plot.title=element_text(size=15,face="bold"),
        axis.title.x = element_text(size=12,face="bold"),
        axis.title.y = element_blank(),
        axis.text.x = element_text(colour="black", size = 12),
        axis.text.y = element_text(colour="black", size = 12),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        panel.background = element_blank(),
        legend.position = "bottom") +
 # scale_y_continuous(trans = log10_trans(), breaks=c(0.75, 0.8, 0.9, 1)) +
  geom_hline(linetype = "dashed", yintercept = 0) +
  coord_flip()

age_factors_plot

#save the plot
ggsave(
  "age_factors_plot.pdf",
  plot = age_factors_plot,
  device = "pdf",
  path = "../plots/age_and_sex/factors/",
  width = 8,
  height = 9
)
#png
ggsave(
  "age_factors_plot.png",
  plot = age_factors_plot,
  device = "png",
  path = "../plots/age_and_sex/factors/",
  width = 8,
  height = 9
)
#jpeg
ggsave(
  "age_factors_plot.jpeg",
  plot = age_factors_plot,
  device = "jpeg",
  path = "../plots/age_and_sex/factors/",
  width = 8,
  height = 9
)
```

### Sex plot
```{r forest plot for sex related variability in factors}
#Sex related variability
sex_factors_plot <- ggplot(
  ALL_CI_factor.sex.ordered,
  aes(x = factor,
      y = estimate,
      ymin = conf.low,
      ymax = conf.high)
  ) +
  geom_pointrange(col="black", fill="black", shape=22) +
  labs(y = "Standardised Estimate (95% CI)",
       x = "Symptom",
       title = "Sex-related variability in anxiety and depression factors",
       subtitle = paste("n(total) = ", length(dat$PHQ.total.score),
                        "; n(female) = ", sum(!is.na(dat$PHQ.total.score[dat$sex=="Female"])),
                        "; n(male) = ", sum(!is.na(dat$PHQ.total.score[dat$sex=="Male"])),"\n",
                        sep = "")) +
  geom_errorbar(aes(ymin=conf.low, ymax=conf.high),width=0.2,cex=1)+
  theme(panel.grid.major.x = element_line(size = 0.5,
                                          linetype = 'dashed',
                                          colour = "gray"),
        plot.title=element_text(size=15,face="bold"),
        axis.title.x = element_text(size=12,face="bold"),
        axis.title.y = element_blank(),
        axis.text.x = element_text(colour="black", size = 12),
        axis.text.y = element_text(colour="black", size = 12),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        panel.background = element_blank(),
        legend.position = "bottom") +
 # scale_y_continuous(trans = log10_trans(), breaks=c(0.5,0.6, 0.8, 1, 1.2, 1.4, 1.6, 1.8, 2)) +
  geom_hline(linetype = "dashed", yintercept = 0) +
  coord_flip()

sex_factors_plot

#save the plot
ggsave(
  "sex_factors_plot.pdf",
  plot = sex_factors_plot,
  device = "pdf",
  path = "../plots/age_and_sex/factors/",
  width = 8,
  height = 9
)
#png
ggsave(
  "sex_factors_plot.png",
  plot = sex_factors_plot,
  device = "png",
  path = "../plots/age_and_sex/factors/",
  width = 8,
  height = 9
)
#jpeg
ggsave(
  "sex_factors_plot.jpeg",
  plot = sex_factors_plot,
  device = "jpeg",
  path = "../plots/age_and_sex/factors/",
  width = 8,
  height = 9
)
```

### Combined 
```{r combined factors plot}
combined_factors_plot <- ggplot(
  ALL_CI_factor.ordered,
  aes(x = factor,
      y = estimate,
      ymin = conf.low,
      ymax = conf.high,
      colour = term)
  ) +
  scale_fill_manual(values = palette3) +
  scale_color_manual(values = palette3) + 
  scale_shape_manual(values = c(19, 21)) +
  geom_pointrange(aes(shape = Significant), position = position_dodge2(width = 0.3), size = 0.8) +
  labs(y = "Standardised Estimate (95% CI)",
       x = "Symptom",
       title = "Age and sex-related variability in anxiety and depression factors",
       subtitle = paste("N(Total) = ", length(dat$PHQ.total.score),
                        "; N(Female) = ", sum(!is.na(dat$PHQ.total.score[dat$sex=="Female"])),
                        "; N(Male) = ", sum(!is.na(dat$PHQ.total.score[dat$sex=="Male"])), sep = ""),
       color = "",
       shape = "") +
  theme(panel.grid.major.x = element_line(size = 0.5,
                                          linetype = 'dashed',
                                          colour = "gray"),
        plot.title = element_text(size = 15, face = "bold", hjust = 0.5),
        axis.title.x = element_text(size = 12, face = "bold"),
        axis.title.y = element_blank(),
        axis.text.x = element_text(colour = "black", size = 9),
        axis.text.y = element_text(colour = "black", size = 12),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        panel.background = element_blank(),
        legend.position = "bottom") +
  geom_hline(linetype = "dashed", yintercept = 0) +
 coord_flip()
combined_factors_plot

#save the plot
ggsave(
  "combined_factors_plot.pdf",
  plot = combined_factors_plot,
  device = "pdf",
  path = "../plots/age_and_sex/factors/",
  width = 8,
  height = 9
)
#png
ggsave(
  "combined_factors_plot.png",
  plot = combined_factors_plot,
  device = "png",
  path = "../plots/age_and_sex/factors/",
  width = 8,
  height = 9
)
#jpeg
ggsave(
  "combined_factors_plot.jpeg",
  plot = combined_factors_plot,
  device = "jpeg",
  path = "../plots/age_and_sex/factors/",
  width = 8,
  height = 9
)
```

# **Sensitivity analysis: Linear regressions rerun for factor associations WITHOUT controlling for sum scores**

*IMPORTANT: HAVE USED THE SAME VARIABLE NAMES HERE SO OLDER MODEL HAS BEEN OVERWRITTEN*

R-squared is a goodness-of-fit measure for linear regression models. 
This statistic indicates the percentage of the variance in the dependent variable that the independent variables explain collectively. 
```{r linear regression models for factor scores}
#Worry factor scores
lin.worry_factor <- lm(worry ~ age_divided + sex,
              data = dat)
summary(lin.worry_factor ) #standard summary of model
CI.lin.worry_factor <- tidy(lin.worry_factor, conf.int = TRUE, exponentiate = TRUE) #tidy summary with confidence intervals
CI.lin.worry_factor <- add_column(CI.lin.worry_factor, #add column to indicate the factor
  factor = "Worry symptoms")
CI.lin.worry_factor #previouslt used OR.log.motor_factor <- exp(coef(log.motor_factor.endorsement)) to get OR
CI.lin.worry_factor.age <- CI.lin.worry_factor[2,1:8]  
CI.lin.worry_factor.age
CI.lin.worry_factor.sex <- CI.lin.worry_factor[3,1:8] 
CI.lin.worry_factor.sex

#Mood factor scores
lin.mood_factor <- lm(mood ~ age_divided + sex,
              data = dat)
summary(lin.mood_factor ) #standard summary of model
CI.lin.mood_factor <- tidy(lin.mood_factor, conf.int = TRUE, exponentiate = TRUE) #tidy summary with confidence intervals
CI.lin.mood_factor <- add_column(CI.lin.mood_factor, #add column to indicate the factor
  factor = "Mood symptoms")
CI.lin.mood_factor 
CI.lin.mood_factor.age <- CI.lin.mood_factor[2,1:8]  
CI.lin.mood_factor.age
CI.lin.mood_factor.sex <- CI.lin.mood_factor[3,1:8]  
CI.lin.mood_factor.sex

#Somatic factor scores
lin.somatic_factor <- lm(somatic ~ age_divided + sex,
              data = dat)
summary(lin.somatic_factor ) #standard summary of model
CI.lin.somatic_factor <- tidy(lin.somatic_factor, conf.int = TRUE, exponentiate = TRUE) #tidy summary with confidence intervals
CI.lin.somatic_factor <- add_column(CI.lin.somatic_factor, #add column to indicate the factor
  factor = "Somatic symptoms")
CI.lin.somatic_factor 
CI.lin.somatic_factor.age <- CI.lin.somatic_factor[2,1:8]  
CI.lin.somatic_factor.age
CI.lin.somatic_factor.sex <- CI.lin.somatic_factor[3,1:8]  
CI.lin.somatic_factor.sex

#Motor factor scores
lin.motor_factor <- lm(motor ~ age_divided + sex,
              data = dat)
summary(lin.motor_factor ) #standard summary of model
CI.lin.motor_factor <- tidy(lin.motor_factor, conf.int = TRUE, exponentiate = TRUE) #tidy summary with confidence intervals
CI.lin.motor_factor <- add_column(CI.lin.motor_factor, #add column to indicate the factor
  factor = "Motor symptoms")
CI.lin.motor_factor 
CI.lin.motor_factor.age <- CI.lin.motor_factor[2,1:8]  
CI.lin.motor_factor.age
CI.lin.motor_factor.sex <- CI.lin.motor_factor[3,1:8]  
CI.lin.motor_factor.sex
```

Combine rows of CIs
```{r combine datasets }
#bind all age rows together
ALL_CI_factor.age <- bind_rows(CI.lin.mood_factor.age, 
                               CI.lin.worry_factor.age, 
                               CI.lin.somatic_factor.age, 
                               CI.lin.motor_factor.age)
#pvalue correction
ALL_CI_factor.age <- ALL_CI_factor.age %>%
  mutate(p.value.adjusted = 
           p.adjust(p.value, 
                    method = "fdr",
                    n = 8)) #calculated separately at only doing 8comparisons
#rename term
ALL_CI_factor.age  <- ALL_CI_factor.age %>%
  mutate(
    term = 
      "Age/10"
  )

#order
ALL_CI_factor.age.ordered <- 
  arrange(ALL_CI_factor.age, desc(estimate))


#bind all sex rows together
ALL_CI_factor.sex <- bind_rows(CI.lin.mood_factor.sex, 
                               CI.lin.worry_factor.sex, 
                               CI.lin.somatic_factor.sex, 
                               CI.lin.motor_factor.sex)
#adjust pvalue
ALL_CI_factor.sex <- ALL_CI_factor.sex %>%
  mutate(p.value.adjusted = 
           p.adjust(p.value, 
                    method = "fdr",
                    n = 16)) #calculated separately at only doing 16 comparisons
#rename term
ALL_CI_factor.sex <- ALL_CI_factor.sex %>%
  mutate(
    term = 
      "Sex (Female)"
  )
#order
ALL_CI_factor.sex.ordered <- 
  arrange(ALL_CI_factor.sex, desc(estimate))

#bind all rows together 
ALL_CI_factor <- bind_rows(ALL_CI_factor.age, ALL_CI_factor.sex)
ALL_CI_factor 

#add significance variable
ALL_CI_factor <- ALL_CI_factor %>%
  mutate(
    Significant.raw = 
      if_else(
        p.value.adjusted < 0.05, 
        1,
        0
      )
  )
#turn into factor
ALL_CI_factor <- ALL_CI_factor %>%
  mutate(Significant = 
  recode_factor(Significant.raw,
    `1` = "Significant",
    `0` = "Non-significant"
      )
  )

#order
ALL_CI_factor.ordered <- arrange(ALL_CI_factor, desc(estimate)) #ordered by age variables 

```

Make the symptom factor variable into a factor
```{r make the factor variable into a factor}
levels_factor <- ALL_CI_factor.sex.ordered$factor

ALL_CI_factor.age.ordered$factor <- factor(ALL_CI_factor.age.ordered$factor, 
                                           levels = paste(ALL_CI_factor.age.ordered$factor, 
                                                          sep = ","))

ALL_CI_factor.sex.ordered$factor <- factor(ALL_CI_factor.sex.ordered$factor, 
                                           levels = paste(ALL_CI_factor.sex.ordered$factor, 
                                                          sep = ","))

ALL_CI_factor.ordered$factor <- factor(ALL_CI_factor.ordered$factor, 
                                           levels = paste(levels_factor, 
                                                          sep = ","))

```

Plot combined graph without controlling for sum scores
```{r plot factors without controlling for sum scores}
combined_factors_plot_without_sum <- ggplot(
  ALL_CI_factor.ordered,
  aes(x = factor,
      y = estimate,
      ymin = conf.low,
      ymax = conf.high,
      colour = term)
  ) +
  scale_fill_manual(values = palette3) +
  scale_color_manual(values = palette3) + 
  scale_shape_manual(values = c(19, 21)) +
  geom_pointrange(aes(shape = Significant), position = position_dodge2(width = 0.3), size = 0.8) +
  labs(y = "Standardised Estimate (95% CI)",
       x = "Symptom",
       color = "",
       shape = "") +
  theme(panel.grid.major.x = element_line(size = 0.5,
                                          linetype = 'dashed',
                                          colour = "gray"),
        plot.title = element_text(size = 15, face = "bold", hjust = 0.5),
        axis.title.x = element_text(size = 12, face = "bold"),
        axis.title.y = element_blank(),
        axis.text.x = element_text(colour = "black", size = 9),
        axis.text.y = element_text(colour = "black", size = 12),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        panel.background = element_blank(),
        legend.position = "bottom") +
  geom_hline(linetype = "dashed", yintercept = 0) +
 coord_flip()
combined_factors_plot_without_sum

#jpeg
ggsave(
  "combined_factors_plot_without_sum",
  plot = combined_factors_plot_without_sum,
  device = "jpeg",
  path = "../plots/age_and_sex/factors/",
  width = 7,
  height = 4
)
```


# Panel plots

## Age and sex variation in symptoms and factors
```{r panel plots for factor and symptoms}
library(ggpubr)
combined_symptoms_plot <- combined_symptoms_plot + 
  labs(title = "Symptom level") + 
  theme(plot.title = element_text(size = 12,face = "bold"),
        axis.title.x = element_text(size = 10, face = "bold"))

combined_factors_plot <- combined_factors_plot + 
  labs(title = "Factor level") + 
  theme(plot.title = element_text(size = 12,face = "bold"),
        axis.title.x = element_text(size = 10, face = "bold"))
  
age_sex_symptom_factor_plot <- ggarrange(combined_symptoms_plot, combined_factors_plot + font("x.text", size = 10),
                    ncol = 2, nrow = 1, labels = c("A", "B"),
                    common.legend = TRUE,
                    legend = "bottom")
age_sex_symptom_factor_plot

#save the plot
ggsave(
  "combined.final_plot.pdf",
  plot = age_sex_symptom_factor_plot,
  device = "pdf",
  path = "../plots/age_and_sex/",
  width = 12,
  height = 6
)
#png
ggsave(
  "combined.final_plot.png",
  plot = age_sex_symptom_factor_plot,
  device = "png",
  path = "../plots/age_and_sex/",
  width = 12,
  height = 6
)
#jpeg
ggsave(
  "combined.final_plot.jpeg",
  plot = age_sex_symptom_factor_plot,
  device = "jpeg",
  path = "../plots/age_and_sex/",
  width = 12,
  height = 6
)
```






























